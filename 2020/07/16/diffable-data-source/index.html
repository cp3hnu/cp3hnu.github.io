<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Diffable Data Source | Study &amp; Product</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="UITableView & UICollectionView åŸºäº Diffable å®ç°å±€éƒ¨åˆ·æ–°ï¼ŒWWDC 2019 Session 220ã€ŠAdvances in UI Data Sourcesã€‹">
    <meta name="algolia-site-verification" content="23333450F18E92C1">
    
    <link rel="preload" href="/assets/css/0.styles.cd1f7b12.css" as="style"><link rel="preload" href="/assets/js/app.b07256e7.js" as="script"><link rel="preload" href="/assets/js/34.49b71b2c.js" as="script"><link rel="preload" href="/assets/js/3.276926dd.js" as="script"><link rel="preload" href="/assets/js/52.e6a458bb.js" as="script"><link rel="prefetch" href="/assets/js/10.7c5bc6fc.js"><link rel="prefetch" href="/assets/js/100.f675d046.js"><link rel="prefetch" href="/assets/js/101.92ede1ec.js"><link rel="prefetch" href="/assets/js/102.678a907d.js"><link rel="prefetch" href="/assets/js/103.959ad108.js"><link rel="prefetch" href="/assets/js/104.b15677eb.js"><link rel="prefetch" href="/assets/js/105.377da8a5.js"><link rel="prefetch" href="/assets/js/106.29a8c44d.js"><link rel="prefetch" href="/assets/js/107.64b19904.js"><link rel="prefetch" href="/assets/js/108.a3e75a67.js"><link rel="prefetch" href="/assets/js/109.283d92d8.js"><link rel="prefetch" href="/assets/js/11.e6a0311f.js"><link rel="prefetch" href="/assets/js/110.cbb6ea81.js"><link rel="prefetch" href="/assets/js/111.252f143f.js"><link rel="prefetch" href="/assets/js/112.df62c9fe.js"><link rel="prefetch" href="/assets/js/113.66189350.js"><link rel="prefetch" href="/assets/js/114.890cd7de.js"><link rel="prefetch" href="/assets/js/115.53823707.js"><link rel="prefetch" href="/assets/js/116.caaa6eaa.js"><link rel="prefetch" href="/assets/js/117.b7b0f88f.js"><link rel="prefetch" href="/assets/js/118.03168974.js"><link rel="prefetch" href="/assets/js/119.90f4d7b7.js"><link rel="prefetch" href="/assets/js/12.8da07182.js"><link rel="prefetch" href="/assets/js/120.b654e5ee.js"><link rel="prefetch" href="/assets/js/121.92d87086.js"><link rel="prefetch" href="/assets/js/13.a9f90626.js"><link rel="prefetch" href="/assets/js/14.b18d5210.js"><link rel="prefetch" href="/assets/js/15.835c7671.js"><link rel="prefetch" href="/assets/js/16.eb29ed80.js"><link rel="prefetch" href="/assets/js/17.c4871518.js"><link rel="prefetch" href="/assets/js/18.606b879c.js"><link rel="prefetch" href="/assets/js/19.777086a8.js"><link rel="prefetch" href="/assets/js/20.c8e69fcc.js"><link rel="prefetch" href="/assets/js/21.6cda2658.js"><link rel="prefetch" href="/assets/js/22.19e356e1.js"><link rel="prefetch" href="/assets/js/23.ca8661ea.js"><link rel="prefetch" href="/assets/js/24.9f090eaf.js"><link rel="prefetch" href="/assets/js/25.be2c8a0c.js"><link rel="prefetch" href="/assets/js/26.5ce52eaa.js"><link rel="prefetch" href="/assets/js/27.d75e1151.js"><link rel="prefetch" href="/assets/js/28.6863d7e4.js"><link rel="prefetch" href="/assets/js/29.d8a1c4f2.js"><link rel="prefetch" href="/assets/js/30.178b8dc0.js"><link rel="prefetch" href="/assets/js/31.4c488d0e.js"><link rel="prefetch" href="/assets/js/32.ce3ae3c7.js"><link rel="prefetch" href="/assets/js/33.828dd0d1.js"><link rel="prefetch" href="/assets/js/35.9496ed4c.js"><link rel="prefetch" href="/assets/js/36.33ada8e1.js"><link rel="prefetch" href="/assets/js/37.e9705ffe.js"><link rel="prefetch" href="/assets/js/38.f9c57096.js"><link rel="prefetch" href="/assets/js/39.75b77f83.js"><link rel="prefetch" href="/assets/js/4.c651aa9d.js"><link rel="prefetch" href="/assets/js/40.4496a5db.js"><link rel="prefetch" href="/assets/js/41.260393e3.js"><link rel="prefetch" href="/assets/js/42.083f9350.js"><link rel="prefetch" href="/assets/js/43.8d311a8e.js"><link rel="prefetch" href="/assets/js/44.df55763b.js"><link rel="prefetch" href="/assets/js/45.e19037c7.js"><link rel="prefetch" href="/assets/js/46.9529f37b.js"><link rel="prefetch" href="/assets/js/47.8d631e39.js"><link rel="prefetch" href="/assets/js/48.3acad59c.js"><link rel="prefetch" href="/assets/js/49.9a12a900.js"><link rel="prefetch" href="/assets/js/5.373c53f3.js"><link rel="prefetch" href="/assets/js/50.f30877b8.js"><link rel="prefetch" href="/assets/js/51.e8b2adf9.js"><link rel="prefetch" href="/assets/js/53.e4027d0c.js"><link rel="prefetch" href="/assets/js/54.5a4be38d.js"><link rel="prefetch" href="/assets/js/55.924ee4f8.js"><link rel="prefetch" href="/assets/js/56.11ff1ccf.js"><link rel="prefetch" href="/assets/js/57.14327960.js"><link rel="prefetch" href="/assets/js/58.cea182b0.js"><link rel="prefetch" href="/assets/js/59.2db874c7.js"><link rel="prefetch" href="/assets/js/6.6878fac4.js"><link rel="prefetch" href="/assets/js/60.e3e4017b.js"><link rel="prefetch" href="/assets/js/61.d5cd385e.js"><link rel="prefetch" href="/assets/js/62.6929f93f.js"><link rel="prefetch" href="/assets/js/63.3f8bf719.js"><link rel="prefetch" href="/assets/js/64.e89e1572.js"><link rel="prefetch" href="/assets/js/65.a4335c65.js"><link rel="prefetch" href="/assets/js/66.cc9fb484.js"><link rel="prefetch" href="/assets/js/67.d5da8f2f.js"><link rel="prefetch" href="/assets/js/68.91a38f6d.js"><link rel="prefetch" href="/assets/js/69.800ca600.js"><link rel="prefetch" href="/assets/js/7.6f2558ea.js"><link rel="prefetch" href="/assets/js/70.f7b16ee7.js"><link rel="prefetch" href="/assets/js/71.e34929dc.js"><link rel="prefetch" href="/assets/js/72.175a64bf.js"><link rel="prefetch" href="/assets/js/73.c3dcfd4b.js"><link rel="prefetch" href="/assets/js/74.65978082.js"><link rel="prefetch" href="/assets/js/75.718d5152.js"><link rel="prefetch" href="/assets/js/76.2ed620b3.js"><link rel="prefetch" href="/assets/js/77.f8726387.js"><link rel="prefetch" href="/assets/js/78.1dea2e59.js"><link rel="prefetch" href="/assets/js/79.f62213a1.js"><link rel="prefetch" href="/assets/js/8.81ebcef8.js"><link rel="prefetch" href="/assets/js/80.7600ac29.js"><link rel="prefetch" href="/assets/js/81.ab94746f.js"><link rel="prefetch" href="/assets/js/82.26baf7f8.js"><link rel="prefetch" href="/assets/js/83.89a3942a.js"><link rel="prefetch" href="/assets/js/84.1a5577ac.js"><link rel="prefetch" href="/assets/js/85.eb62de22.js"><link rel="prefetch" href="/assets/js/86.7635121c.js"><link rel="prefetch" href="/assets/js/87.5bee4d72.js"><link rel="prefetch" href="/assets/js/88.04d56860.js"><link rel="prefetch" href="/assets/js/89.09a7d920.js"><link rel="prefetch" href="/assets/js/9.7f69b9b1.js"><link rel="prefetch" href="/assets/js/90.dac6a66e.js"><link rel="prefetch" href="/assets/js/91.14f101dd.js"><link rel="prefetch" href="/assets/js/92.d398eb09.js"><link rel="prefetch" href="/assets/js/93.7a5477fa.js"><link rel="prefetch" href="/assets/js/94.c4bf7674.js"><link rel="prefetch" href="/assets/js/95.a0c3c94c.js"><link rel="prefetch" href="/assets/js/96.c3a44db5.js"><link rel="prefetch" href="/assets/js/97.6956ed39.js"><link rel="prefetch" href="/assets/js/98.ad65fe08.js"><link rel="prefetch" href="/assets/js/99.4fe76e2f.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.cb5d1302.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cd1f7b12.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Study &amp; Product </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/notebook/" class="nav-link">Notebook</a></li><li class="nav-item"><a href="/about/" class="nav-link">About</a></li><li class="nav-item"><a href="https://github.com/cp3hnu" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Study &amp; Product </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/notebook/" class="nav-link">Notebook</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About</a></li><li class="mobile-nav-item"><a href="https://github.com/cp3hnu" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div itemprop="articleBody" class="content__default"><h1 id="diffable-data-source"><a href="#diffable-data-source" class="header-anchor">#</a> Diffable Data Source</h1> <h2 id="data-source-ä½¿ç”¨ç°çŠ¶"><a href="#data-source-ä½¿ç”¨ç°çŠ¶" class="header-anchor">#</a> Data Source ä½¿ç”¨ç°çŠ¶</h2> <p>åœ¨ iOS å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨ <code>UITableView</code> å’Œ <code>UICollectionView</code> ç»„ä»¶ï¼Œåœ¨è¿‡å»æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ Data Source æ¥é…ç½®æ•°æ®æºã€‚åœ¨ç®€å•çš„ä¸šåŠ¡ä¸­æˆ‘ä»¬å¯ä»¥æ„‰å¿«çš„å®ç°å„ç§éœ€æ±‚ï¼Œå¯æ˜¯ä¸€æ—¦ä¸šåŠ¡å¤æ‚èµ·æ¥ï¼Œæ¯”å¦‚æ•°æ®æºå®æ—¶çš„å¢åˆ æ”¹ï¼Œæˆ‘ä»¬ç»å¸¸ä¸€ä¸å°å¿ƒå°±é‡åˆ° <code>NSInternalInconsistencyException</code>ï¼ˆæ•°æ®æºå’Œå½“å‰ UI çŠ¶æ€ä¸ä¸€è‡´ï¼‰çš„é—®é¢˜ï¼Œé‚£æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p> <p>ä»¥å‰æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªè§£å†³æ–¹æ³•æ˜¯ç®€å•ç²—æš´çš„è°ƒç”¨ <code>reloadData</code> æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆæœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œ1ã€å½±å“æ€§èƒ½ï¼Œæ•°æ®æºå¯èƒ½åªæœ‰ä¸€å¤„å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œ <code>reloadData</code> åˆ·æ–°äº†æ•´ä¸ªåˆ—è¡¨æ•°æ®ï¼›2ã€æ²¡æœ‰åŠ¨ç”»æ•ˆæœï¼Œç”¨æˆ·ä¸èƒ½å¾ˆå¥½åœ°æ„ŸçŸ¥åˆ—è¡¨ä¸­å“ªé‡Œå‘ç”Ÿäº†å˜åŒ–ã€‚</p> <p>ç¬¬äºŒä¸ªè§£å†³æ–¹æ³•æ˜¯ï¼Œæ‰‹åŠ¨å±€éƒ¨åˆ·æ–°ï¼Œä¾‹å¦‚ä¸‹é¢åˆ é™¤æŸä¸€è¡Œçš„ä»£ç </p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>tableView<span class="token punctuation">.</span><span class="token function">beginUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
data<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>indexPath<span class="token punctuation">.</span>row<span class="token punctuation">)</span>
tableView<span class="token punctuation">.</span><span class="token function">deleteRows</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> <span class="token punctuation">[</span>indexPath<span class="token punctuation">]</span><span class="token punctuation">,</span> with<span class="token punctuation">:</span> <span class="token punctuation">.</span>fade<span class="token punctuation">)</span>
tableView<span class="token punctuation">.</span><span class="token function">endUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å°½ç®¡å¦‚ä¸Šä»£ç æ»¡è¶³éœ€æ±‚ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¾—ä¸è®¡ç®—éœ€è¦æ’å…¥æˆ–è€…åˆ é™¤çš„çš„ indexPaths ï¼Œè€Œä¸”ç¨æœ‰ä¸æ…æˆ‘ä»¬å°†ä¼šé‡åˆ°ä¸‹é¢è¿™ä¸ªç†Ÿæ‚‰çš„å¼‚å¸¸ğŸ˜±</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>*** Terminating app due to uncaught exception

<span class="token string">'NSInternalInconsistencyException'</span>,

reason: <span class="token string">'Invalid update: invalid number of sections. The number of sections contained in the tableView view after the update (1) must be equal to the number of sections contained in the tableView view before the update (1), plus or minus the number of sections inserted or deleted (0 inserted, 1 deleted).'</span>

***
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>ä¸ºæ­¤ iOS 13 æå‡ºäº†æ–°çš„è§£å†³æ–¹æ¡ˆï¼Œ<strong>Diffable Data Source</strong></p> <h2 id="new-apis"><a href="#new-apis" class="header-anchor">#</a> New APIs</h2> <p><img src="/assets/img/220-1.9683b8e1.png" alt=""></p> <p><strong>Diffable Data Source</strong> ï¼Œè®©å¼€å‘è€…å¯ä»¥æ›´ç®€å•é«˜æ•ˆçš„å®ç° <code>UITableView</code>ã€<code>UICollectionView</code> çš„å±€éƒ¨æ•°æ®åˆ·æ–°ã€‚å…¶æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®°å½•å˜åŒ–å‰å’Œå˜åŒ–åçš„æ•°æ®å¿«ç…§ï¼Œå†…éƒ¨è®¡ç®—ä¸¤æ¬¡å¿«ç…§çš„å·®å¼‚ï¼Œç„¶åæ›´æ–° UIã€‚</p> <blockquote><p>Noteï¼šåœ¨è½¯ä»¶å¼€å‘ä¸­ Diff æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œæœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯ï¼Œå¦‚ git ç‰ˆæœ¬ç®¡ç†ä¸­æ–‡ä»¶å˜æ›´åº”ç”¨ï¼›Reactä¸­è™šæ‹ŸDOM ç”¨ Diffç®—æ³•æ›´æ–° UI çŠ¶æ€ï¼›IGListKit é€šè¿‡ IGListDiff è‡ªåŠ¨è®¡ç®—å‰åä¸¤æ¬¡æ•°æ®æºçš„å·®å€¼ï¼Œå®ç°å±€éƒ¨æ•°æ®åˆ·æ–°ã€‚</p></blockquote> <p>ç¬”è€…ä»¥ <code>UITableViewDiffableDataSource</code> ä½œä¸ºåˆ‡å…¥ç‚¹è¿›è¡Œè®²è§£ï¼Œå…¶å®ƒä¸¤ä¸ªç”¨æ³•ç±»ä¼¼</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> <span class="token builtin">NSObject</span><span class="token punctuation">,</span> <span class="token builtin">UITableViewDataSource</span> <span class="token keyword">where</span> <span class="token builtin">SectionIdentifierType</span> <span class="token punctuation">:</span> <span class="token builtin">Hashable</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span> <span class="token punctuation">:</span> <span class="token builtin">Hashable</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>æˆ‘ä»¬çœ‹åˆ° <code>UITableViewDiffableDataSource</code> ç±»å®ç°äº† <code>UITableViewDataSource</code> åè®®,  ç”¨æ¥ç»´æŠ¤  table view çš„æ•°æ®æºï¼ŒSection å’Œ Item éµå¾ª <code>IdentifierType</code>ï¼Œä»è€Œç¡®ä¿æ¯æ¡æ•°æ®çš„å”¯ä¸€æ€§ï¼Œåˆå§‹åŒ–æ–¹æ³•å¦‚ä¸‹ï¼š</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">init</span><span class="token punctuation">(</span>tableView<span class="token punctuation">:</span> <span class="token builtin">UITableView</span><span class="token punctuation">,</span> cellProvider<span class="token punctuation">:</span> @escaping <span class="token builtin">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token builtin">CellProvider</span><span class="token punctuation">)</span>

<span class="token keyword">typealias</span> <span class="token builtin">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token builtin">CellProvider</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">UITableView</span><span class="token punctuation">,</span> <span class="token builtin">IndexPath</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">UITableViewCell</span><span class="token operator">?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ä½¿ç”¨è¿‡ RxCocoa çš„å¯èƒ½å¯¹ CellProvider å¾ˆçœ¼ç†Ÿï¼Œæ²¡é”™ä»¥åæˆ‘ä»¬å¯ä»¥åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­é…ç½® Cellï¼Œåœ¨æˆ‘ä»¬é…ç½®å¥½ <code>UITableViewDiffableDataSource</code> åï¼Œä½¿ç”¨ <code>apply</code>  snapshot å¯¹ table view è¿›è¡Œåˆ·æ–°</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token number">_</span> snapshot<span class="token punctuation">:</span> <span class="token builtin">NSDiffableDataSourceSnapshot</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> animatingDifferences<span class="token punctuation">:</span> <span class="token builtin">Bool</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> completion<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token constant">nil</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>é€šè¿‡ä½¿ç”¨ <code>apply</code> æˆ‘ä»¬æ— éœ€è®¡ç®—å˜æ›´çš„ <code>indexPaths</code>ï¼Œä¹Ÿæ— éœ€è°ƒç”¨ <code>reloadData</code>æ–¹æ³•ï¼Œå³å¯å®‰å…¨åœ¨åœ¨ä¸»çº¿ç¨‹æˆ–<strong>åå°çº¿ç¨‹</strong>æ›´æ–° UIï¼Œä»…ä»…åªéœ€è¦å°†å˜æ›´åçš„æ•°æ®é€šè¿‡ <code>NSDiffableDataSourceSnapshot</code> è®¡ç®—å‡ºæ¥ï¼Œ<code>NSDiffableDataSourceSnapshot</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">NSDiffableDataSourceSnapshot</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span> <span class="token keyword">where</span> <span class="token builtin">SectionIdentifierType</span> <span class="token punctuation">:</span> <span class="token builtin">Hashable</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span> <span class="token punctuation">:</span> <span class="token builtin">Hashable</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>åˆ›å»º snapshot æœ‰ä¸¤ç§æ–¹æ³•</p> <ul><li>åˆ›å»ºä¸€ä¸ªç©ºçš„ snapshotï¼Œ ç„¶åé€šè¿‡  <code>append</code> æ–¹æ³•æ·»åŠ æ•°æ®ã€‚</li> <li>é€šè¿‡ diffable data source çš„ <code>snapshot()</code> æ–¹æ³•è·å–å½“å‰çš„ snapshotï¼Œ ç„¶åé€šè¿‡  <code>append</code> , <code>delete</code>, <code>move</code>, <code>insert</code> æ–¹æ³•ä¿®æ”¹æ•°æ®ã€‚</li></ul> <p>ä»‹ç»åˆ°åœ¨è¿™é‡Œ <strong>Diffable Data Source</strong> å…³é”®æ¦‚å¿µå·®ä¸å¤šä»‹ç»å®Œäº†ï¼Œè¿™é‡Œæ•´ç†ä¸€ä¸‹æµç¨‹</p> <ol><li><p><code>UITableViewDiffableDataSource</code> è´Ÿè´£å½“å‰æ•°æ®æºé…ç½®ï¼Œæ¯”å¦‚é…ç½® cell</p></li> <li><p><code>NSDiffableDataSourceSnapshot</code> è´Ÿè´£æ•°æ®æºçš„å˜æ›´</p></li> <li><p><code>UITableViewDiffableDataSource</code>  é€šè¿‡è°ƒç”¨ <code>apply</code> æ–¹æ³•å°† <code>NSDiffableDataSourceSnapshot</code>  å˜æ›´åçš„æ•°æ®æ›´æ–°åŒæ­¥åˆ° <code>UITableView</code>ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ä¸ºäº†ç¡®ä¿ Diff ç”Ÿæ•ˆï¼Œæ‰€ä»¥æ•°æ®å¿…é¡»å…·æœ‰å”¯ä¸€ Identifierï¼Œä¸”éµå¾ª <code>Hashable</code> åè®®</p></li></ol> <h2 id="demo"><a href="#demo" class="header-anchor">#</a> Demo</h2> <p>ä»¥ <a href="https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/implementing_modern_collection_views" target="_blank" rel="noopener noreferrer">Implementing Modern Collection Views<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ä¸­çš„ Wifi Setting ä¸ºä¾‹</p> <p><img src="/assets/img/220-2.91087095.png" alt=""></p> <ol><li>å®šä¹‰ <code>UITableViewDiffableDataSource</code>ï¼Œé…ç½® cell</li></ol> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code> <span class="token keyword">self</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> <span class="token builtin">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token builtin">Section</span><span class="token punctuation">,</span> <span class="token builtin">Item</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tableView<span class="token punctuation">:</span> tableView<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span>
                <span class="token punctuation">(</span>tableView<span class="token punctuation">:</span> <span class="token builtin">UITableView</span><span class="token punctuation">,</span> indexPath<span class="token punctuation">:</span> <span class="token builtin">IndexPath</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token builtin">Item</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">UITableViewCell</span><span class="token operator">?</span> <span class="token keyword">in</span>
  
  <span class="token keyword">let</span> cell <span class="token operator">=</span> tableView<span class="token punctuation">.</span><span class="token function">dequeueReusableCell</span><span class="token punctuation">(</span>
    withIdentifier<span class="token punctuation">:</span> <span class="token builtin">WiFiSettingsViewController</span><span class="token punctuation">.</span>reuseIdentifier<span class="token punctuation">,</span>
    <span class="token keyword">for</span><span class="token punctuation">:</span> indexPath<span class="token punctuation">)</span>
  <span class="token comment">// é…ç½® cell</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> cell
<span class="token punctuation">}</span>
<span class="token keyword">self</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span>defaultRowAnimation <span class="token operator">=</span> <span class="token punctuation">.</span>fade
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>å…³äº Section, Item çš„å®šä¹‰ï¼Œå…³é”®ä¸€ç‚¹æ˜¯è¦éµä»  <code>Hashable</code> åè®®</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token comment">// æ²¡æœ‰ associated å€¼çš„æšä¸¾ç±»å‹è‡ªåŠ¨éµä» Hashable åè®®</span>
<span class="token keyword">enum</span> <span class="token builtin">Section</span><span class="token punctuation">:</span> <span class="token builtin">CaseIterable</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> config<span class="token punctuation">,</span> networks
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token builtin">Item</span><span class="token punctuation">:</span> <span class="token builtin">Hashable</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> title<span class="token punctuation">:</span> <span class="token builtin">String</span>
  <span class="token keyword">let</span> type<span class="token punctuation">:</span> <span class="token builtin">ItemType</span>
  <span class="token keyword">let</span> network<span class="token punctuation">:</span> <span class="token builtin">WiFiController</span><span class="token punctuation">.</span><span class="token builtin">Network</span><span class="token operator">?</span>
  <span class="token keyword">private</span> <span class="token keyword">let</span> identifier<span class="token punctuation">:</span> <span class="token constant">UUID</span>

  <span class="token comment">// å®ç° Hashable åè®®</span>
  <span class="token keyword">func</span> <span class="token function">hash</span><span class="token punctuation">(</span>into hasher<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token builtin">Hasher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hasher<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>identifier<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="2"><li>å®šä¹‰ <code>NSDiffableDataSourceSnapshot</code>ï¼Œè´Ÿè´£æ•°æ®æºçš„å˜æ›´</li></ol> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">let</span> configItems <span class="token operator">=</span> configurationItems<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token punctuation">{</span> <span class="token operator">!</span><span class="token punctuation">(</span>$<span class="token number">0</span><span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token punctuation">.</span>currentNetwork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>controller<span class="token punctuation">.</span>wifiEnabled<span class="token punctuation">)</span> <span class="token punctuation">}</span>
currentSnapshot <span class="token operator">=</span> <span class="token builtin">NSDiffableDataSourceSnapshot</span><span class="token operator">&lt;</span><span class="token builtin">Section</span><span class="token punctuation">,</span> <span class="token builtin">Item</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
currentSnapshot<span class="token punctuation">.</span><span class="token function">appendSections</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">.</span>config<span class="token punctuation">]</span><span class="token punctuation">)</span>
currentSnapshot<span class="token punctuation">.</span><span class="token function">appendItems</span><span class="token punctuation">(</span>configItems<span class="token punctuation">,</span> toSection<span class="token punctuation">:</span> <span class="token punctuation">.</span>config<span class="token punctuation">)</span>

<span class="token keyword">if</span> controller<span class="token punctuation">.</span>wifiEnabled <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sortedNetworks <span class="token operator">=</span> controller<span class="token punctuation">.</span>availableNetworks<span class="token punctuation">.</span><span class="token builtin">sorted</span> <span class="token punctuation">{</span> $<span class="token number">0</span><span class="token punctuation">.</span>name <span class="token operator">&lt;</span> $<span class="token number">1</span><span class="token punctuation">.</span>name <span class="token punctuation">}</span>
  <span class="token keyword">let</span> networkItems <span class="token operator">=</span> sortedNetworks<span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> <span class="token function">Item</span><span class="token punctuation">(</span>network<span class="token punctuation">:</span> $<span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
  currentSnapshot<span class="token punctuation">.</span><span class="token function">appendSections</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">.</span>networks<span class="token punctuation">]</span><span class="token punctuation">)</span>
  currentSnapshot<span class="token punctuation">.</span><span class="token function">appendItems</span><span class="token punctuation">(</span>networkItems<span class="token punctuation">,</span> toSection<span class="token punctuation">:</span> <span class="token punctuation">.</span>networks<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="3"><li>è°ƒç”¨ <code>apply</code> æ–¹æ³•å°† <code>NSDiffableDataSourceSnapshot</code>  å˜æ›´åçš„æ•°æ®æ›´æ–°åŒæ­¥åˆ° <code>UITableView</code></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code> self.dataSource.apply(currentSnapshot, animatingDifferences: animated)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="å…¶å®ƒæ–¹é¢"><a href="#å…¶å®ƒæ–¹é¢" class="header-anchor">#</a> å…¶å®ƒæ–¹é¢</h2> <ol><li><p>ä½¿ç”¨ <code>apply</code> æ–¹æ³•ï¼Œä¸è¦å†ä½¿ç”¨è€å°± <code>performBatchUpdates</code> , <code>insertItems</code></p></li> <li><p>æ–°çš„ APIsï¼Œä¸ä¼šåœ¨ç”¨çš„ indexPathï¼Œä½†æ˜¯ä»¥å‰çš„ APIs å¯èƒ½è¿˜éœ€è¦å®ƒï¼Œæ€ä¹ˆåŠï¼Ÿ<code>NSDiffableDataSourceSnapshot</code> æä¾›äº†å¾ˆå¤šè½¬æ¢æ–¹æ³•</p></li> <li><p><code>apply</code> æ–¹æ³•è¿è¡Œå¾ˆå¿«ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯O(N)</p></li> <li><p><code>apply</code> æ–¹æ³•å¯ä»¥åœ¨åå°çº¿ç¨‹é‡Œå®‰å…¨çš„è¿è¡Œï¼Œå½“æ•°æ®å¾ˆå¤šå¾ˆå¤šæ—¶ï¼Œå¯ä»¥åœ¨åå°çº¿ç¨‹é‡Œè¿è¡Œ <code>apply</code> æ–¹æ³•</p></li> <li><p>Share Sheet å·²ç»é‡‡ç”¨æ–°çš„ APIs</p></li></ol> <h2 id="å‚è€ƒé˜…è¯»"><a href="#å‚è€ƒé˜…è¯»" class="header-anchor">#</a> å‚è€ƒé˜…è¯»</h2> <ul><li>Sample Code</li></ul> <p><a href="https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/implementing_modern_collection_views" target="_blank" rel="noopener noreferrer">Implementing Modern Collection Views<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>WWDC 2019 Session 220</li></ul> <p><a href="https://developer.apple.com/videos/play/wwdc2019/220/" target="_blank" rel="noopener noreferrer">Advances in UI Data Sources<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#data-source-ä½¿ç”¨ç°çŠ¶" title="Data Source ä½¿ç”¨ç°çŠ¶">Data Source ä½¿ç”¨ç°çŠ¶</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#new-apis" title="New APIs">New APIs</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#demo" title="Demo">Demo</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#å…¶å®ƒæ–¹é¢" title="å…¶å®ƒæ–¹é¢">å…¶å®ƒæ–¹é¢</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#å‚è€ƒé˜…è¯»" title="å‚è€ƒé˜…è¯»">å‚è€ƒé˜…è¯»</a></div></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b07256e7.js" defer></script><script src="/assets/js/34.49b71b2c.js" defer></script><script src="/assets/js/3.276926dd.js" defer></script><script src="/assets/js/52.e6a458bb.js" defer></script>
  </body>
</html>
