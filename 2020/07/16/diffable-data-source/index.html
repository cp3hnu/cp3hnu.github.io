<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Diffable Data Source | Study &amp; Product</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="UITableView & UICollectionView 基于 Diffable 实现局部刷新，WWDC 2019 Session 220《Advances in UI Data Sources》">
    <meta name="algolia-site-verification" content="23333450F18E92C1">
    
    <link rel="preload" href="/assets/css/0.styles.cd1f7b12.css" as="style"><link rel="preload" href="/assets/js/app.b07256e7.js" as="script"><link rel="preload" href="/assets/js/34.49b71b2c.js" as="script"><link rel="preload" href="/assets/js/3.276926dd.js" as="script"><link rel="preload" href="/assets/js/52.e6a458bb.js" as="script"><link rel="prefetch" href="/assets/js/10.7c5bc6fc.js"><link rel="prefetch" href="/assets/js/100.f675d046.js"><link rel="prefetch" href="/assets/js/101.92ede1ec.js"><link rel="prefetch" href="/assets/js/102.678a907d.js"><link rel="prefetch" href="/assets/js/103.959ad108.js"><link rel="prefetch" href="/assets/js/104.b15677eb.js"><link rel="prefetch" href="/assets/js/105.377da8a5.js"><link rel="prefetch" href="/assets/js/106.29a8c44d.js"><link rel="prefetch" href="/assets/js/107.64b19904.js"><link rel="prefetch" href="/assets/js/108.a3e75a67.js"><link rel="prefetch" href="/assets/js/109.283d92d8.js"><link rel="prefetch" href="/assets/js/11.e6a0311f.js"><link rel="prefetch" href="/assets/js/110.cbb6ea81.js"><link rel="prefetch" href="/assets/js/111.252f143f.js"><link rel="prefetch" href="/assets/js/112.df62c9fe.js"><link rel="prefetch" href="/assets/js/113.66189350.js"><link rel="prefetch" href="/assets/js/114.890cd7de.js"><link rel="prefetch" href="/assets/js/115.53823707.js"><link rel="prefetch" href="/assets/js/116.caaa6eaa.js"><link rel="prefetch" href="/assets/js/117.b7b0f88f.js"><link rel="prefetch" href="/assets/js/118.03168974.js"><link rel="prefetch" href="/assets/js/119.90f4d7b7.js"><link rel="prefetch" href="/assets/js/12.8da07182.js"><link rel="prefetch" href="/assets/js/120.b654e5ee.js"><link rel="prefetch" href="/assets/js/121.92d87086.js"><link rel="prefetch" href="/assets/js/13.a9f90626.js"><link rel="prefetch" href="/assets/js/14.b18d5210.js"><link rel="prefetch" href="/assets/js/15.835c7671.js"><link rel="prefetch" href="/assets/js/16.eb29ed80.js"><link rel="prefetch" href="/assets/js/17.c4871518.js"><link rel="prefetch" href="/assets/js/18.606b879c.js"><link rel="prefetch" href="/assets/js/19.777086a8.js"><link rel="prefetch" href="/assets/js/20.c8e69fcc.js"><link rel="prefetch" href="/assets/js/21.6cda2658.js"><link rel="prefetch" href="/assets/js/22.19e356e1.js"><link rel="prefetch" href="/assets/js/23.ca8661ea.js"><link rel="prefetch" href="/assets/js/24.9f090eaf.js"><link rel="prefetch" href="/assets/js/25.be2c8a0c.js"><link rel="prefetch" href="/assets/js/26.5ce52eaa.js"><link rel="prefetch" href="/assets/js/27.d75e1151.js"><link rel="prefetch" href="/assets/js/28.6863d7e4.js"><link rel="prefetch" href="/assets/js/29.d8a1c4f2.js"><link rel="prefetch" href="/assets/js/30.178b8dc0.js"><link rel="prefetch" href="/assets/js/31.4c488d0e.js"><link rel="prefetch" href="/assets/js/32.ce3ae3c7.js"><link rel="prefetch" href="/assets/js/33.828dd0d1.js"><link rel="prefetch" href="/assets/js/35.9496ed4c.js"><link rel="prefetch" href="/assets/js/36.33ada8e1.js"><link rel="prefetch" href="/assets/js/37.e9705ffe.js"><link rel="prefetch" href="/assets/js/38.f9c57096.js"><link rel="prefetch" href="/assets/js/39.75b77f83.js"><link rel="prefetch" href="/assets/js/4.c651aa9d.js"><link rel="prefetch" href="/assets/js/40.4496a5db.js"><link rel="prefetch" href="/assets/js/41.260393e3.js"><link rel="prefetch" href="/assets/js/42.083f9350.js"><link rel="prefetch" href="/assets/js/43.8d311a8e.js"><link rel="prefetch" href="/assets/js/44.df55763b.js"><link rel="prefetch" href="/assets/js/45.e19037c7.js"><link rel="prefetch" href="/assets/js/46.9529f37b.js"><link rel="prefetch" href="/assets/js/47.8d631e39.js"><link rel="prefetch" href="/assets/js/48.3acad59c.js"><link rel="prefetch" href="/assets/js/49.9a12a900.js"><link rel="prefetch" href="/assets/js/5.373c53f3.js"><link rel="prefetch" href="/assets/js/50.f30877b8.js"><link rel="prefetch" href="/assets/js/51.e8b2adf9.js"><link rel="prefetch" href="/assets/js/53.e4027d0c.js"><link rel="prefetch" href="/assets/js/54.5a4be38d.js"><link rel="prefetch" href="/assets/js/55.924ee4f8.js"><link rel="prefetch" href="/assets/js/56.11ff1ccf.js"><link rel="prefetch" href="/assets/js/57.14327960.js"><link rel="prefetch" href="/assets/js/58.cea182b0.js"><link rel="prefetch" href="/assets/js/59.2db874c7.js"><link rel="prefetch" href="/assets/js/6.6878fac4.js"><link rel="prefetch" href="/assets/js/60.e3e4017b.js"><link rel="prefetch" href="/assets/js/61.d5cd385e.js"><link rel="prefetch" href="/assets/js/62.6929f93f.js"><link rel="prefetch" href="/assets/js/63.3f8bf719.js"><link rel="prefetch" href="/assets/js/64.e89e1572.js"><link rel="prefetch" href="/assets/js/65.a4335c65.js"><link rel="prefetch" href="/assets/js/66.cc9fb484.js"><link rel="prefetch" href="/assets/js/67.d5da8f2f.js"><link rel="prefetch" href="/assets/js/68.91a38f6d.js"><link rel="prefetch" href="/assets/js/69.800ca600.js"><link rel="prefetch" href="/assets/js/7.6f2558ea.js"><link rel="prefetch" href="/assets/js/70.f7b16ee7.js"><link rel="prefetch" href="/assets/js/71.e34929dc.js"><link rel="prefetch" href="/assets/js/72.175a64bf.js"><link rel="prefetch" href="/assets/js/73.c3dcfd4b.js"><link rel="prefetch" href="/assets/js/74.65978082.js"><link rel="prefetch" href="/assets/js/75.718d5152.js"><link rel="prefetch" href="/assets/js/76.2ed620b3.js"><link rel="prefetch" href="/assets/js/77.f8726387.js"><link rel="prefetch" href="/assets/js/78.1dea2e59.js"><link rel="prefetch" href="/assets/js/79.f62213a1.js"><link rel="prefetch" href="/assets/js/8.81ebcef8.js"><link rel="prefetch" href="/assets/js/80.7600ac29.js"><link rel="prefetch" href="/assets/js/81.ab94746f.js"><link rel="prefetch" href="/assets/js/82.26baf7f8.js"><link rel="prefetch" href="/assets/js/83.89a3942a.js"><link rel="prefetch" href="/assets/js/84.1a5577ac.js"><link rel="prefetch" href="/assets/js/85.eb62de22.js"><link rel="prefetch" href="/assets/js/86.7635121c.js"><link rel="prefetch" href="/assets/js/87.5bee4d72.js"><link rel="prefetch" href="/assets/js/88.04d56860.js"><link rel="prefetch" href="/assets/js/89.09a7d920.js"><link rel="prefetch" href="/assets/js/9.7f69b9b1.js"><link rel="prefetch" href="/assets/js/90.dac6a66e.js"><link rel="prefetch" href="/assets/js/91.14f101dd.js"><link rel="prefetch" href="/assets/js/92.d398eb09.js"><link rel="prefetch" href="/assets/js/93.7a5477fa.js"><link rel="prefetch" href="/assets/js/94.c4bf7674.js"><link rel="prefetch" href="/assets/js/95.a0c3c94c.js"><link rel="prefetch" href="/assets/js/96.c3a44db5.js"><link rel="prefetch" href="/assets/js/97.6956ed39.js"><link rel="prefetch" href="/assets/js/98.ad65fe08.js"><link rel="prefetch" href="/assets/js/99.4fe76e2f.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.cb5d1302.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cd1f7b12.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Study &amp; Product </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/notebook/" class="nav-link">Notebook</a></li><li class="nav-item"><a href="/about/" class="nav-link">About</a></li><li class="nav-item"><a href="https://github.com/cp3hnu" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Study &amp; Product </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/notebook/" class="nav-link">Notebook</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About</a></li><li class="mobile-nav-item"><a href="https://github.com/cp3hnu" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div itemprop="articleBody" class="content__default"><h1 id="diffable-data-source"><a href="#diffable-data-source" class="header-anchor">#</a> Diffable Data Source</h1> <h2 id="data-source-使用现状"><a href="#data-source-使用现状" class="header-anchor">#</a> Data Source 使用现状</h2> <p>在 iOS 开发中，我们经常使用 <code>UITableView</code> 和 <code>UICollectionView</code> 组件，在过去我们通常使用 Data Source 来配置数据源。在简单的业务中我们可以愉快的实现各种需求，可是一旦业务复杂起来，比如数据源实时的增删改，我们经常一不小心就遇到 <code>NSInternalInconsistencyException</code>（数据源和当前 UI 状态不一致）的问题，那怎么解决这个问题呢？</p> <p>以前有两个解决方法，第一个解决方法是简单粗暴的调用 <code>reloadData</code> 方法，但是这个方案有两个问题，1、影响性能，数据源可能只有一处发生了变化，而 <code>reloadData</code> 刷新了整个列表数据；2、没有动画效果，用户不能很好地感知列表中哪里发生了变化。</p> <p>第二个解决方法是，手动局部刷新，例如下面删除某一行的代码</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>tableView<span class="token punctuation">.</span><span class="token function">beginUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
data<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>indexPath<span class="token punctuation">.</span>row<span class="token punctuation">)</span>
tableView<span class="token punctuation">.</span><span class="token function">deleteRows</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> <span class="token punctuation">[</span>indexPath<span class="token punctuation">]</span><span class="token punctuation">,</span> with<span class="token punctuation">:</span> <span class="token punctuation">.</span>fade<span class="token punctuation">)</span>
tableView<span class="token punctuation">.</span><span class="token function">endUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>尽管如上代码满足需求，但是我们不得不计算需要插入或者删除的的 indexPaths ，而且稍有不慎我们将会遇到下面这个熟悉的异常😱</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>*** Terminating app due to uncaught exception

<span class="token string">'NSInternalInconsistencyException'</span>,

reason: <span class="token string">'Invalid update: invalid number of sections. The number of sections contained in the tableView view after the update (1) must be equal to the number of sections contained in the tableView view before the update (1), plus or minus the number of sections inserted or deleted (0 inserted, 1 deleted).'</span>

***
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>为此 iOS 13 提出了新的解决方案，<strong>Diffable Data Source</strong></p> <h2 id="new-apis"><a href="#new-apis" class="header-anchor">#</a> New APIs</h2> <p><img src="/assets/img/220-1.9683b8e1.png" alt=""></p> <p><strong>Diffable Data Source</strong> ，让开发者可以更简单高效的实现 <code>UITableView</code>、<code>UICollectionView</code> 的局部数据刷新。其核心思想就是记录变化前和变化后的数据快照，内部计算两次快照的差异，然后更新 UI。</p> <blockquote><p>Note：在软件开发中 Diff 是一个很重要的概念，有很多应用场景，如 git 版本管理中文件变更应用；React中虚拟DOM 用 Diff算法更新 UI 状态；IGListKit 通过 IGListDiff 自动计算前后两次数据源的差值，实现局部数据刷新。</p></blockquote> <p>笔者以 <code>UITableViewDiffableDataSource</code> 作为切入点进行讲解，其它两个用法类似</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> <span class="token builtin">NSObject</span><span class="token punctuation">,</span> <span class="token builtin">UITableViewDataSource</span> <span class="token keyword">where</span> <span class="token builtin">SectionIdentifierType</span> <span class="token punctuation">:</span> <span class="token builtin">Hashable</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span> <span class="token punctuation">:</span> <span class="token builtin">Hashable</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们看到 <code>UITableViewDiffableDataSource</code> 类实现了 <code>UITableViewDataSource</code> 协议,  用来维护  table view 的数据源，Section 和 Item 遵循 <code>IdentifierType</code>，从而确保每条数据的唯一性，初始化方法如下：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">init</span><span class="token punctuation">(</span>tableView<span class="token punctuation">:</span> <span class="token builtin">UITableView</span><span class="token punctuation">,</span> cellProvider<span class="token punctuation">:</span> @escaping <span class="token builtin">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token builtin">CellProvider</span><span class="token punctuation">)</span>

<span class="token keyword">typealias</span> <span class="token builtin">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token builtin">CellProvider</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">UITableView</span><span class="token punctuation">,</span> <span class="token builtin">IndexPath</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">UITableViewCell</span><span class="token operator">?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用过 RxCocoa 的可能对 CellProvider 很眼熟，没错以后我们可以在初始化方法中配置 Cell，在我们配置好 <code>UITableViewDiffableDataSource</code> 后，使用 <code>apply</code>  snapshot 对 table view 进行刷新</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token number">_</span> snapshot<span class="token punctuation">:</span> <span class="token builtin">NSDiffableDataSourceSnapshot</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> animatingDifferences<span class="token punctuation">:</span> <span class="token builtin">Bool</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> completion<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token constant">nil</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过使用 <code>apply</code> 我们无需计算变更的 <code>indexPaths</code>，也无需调用 <code>reloadData</code>方法，即可安全在在主线程或<strong>后台线程</strong>更新 UI，仅仅只需要将变更后的数据通过 <code>NSDiffableDataSourceSnapshot</code> 计算出来，<code>NSDiffableDataSourceSnapshot</code> 的定义如下：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">NSDiffableDataSourceSnapshot</span><span class="token operator">&lt;</span><span class="token builtin">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span><span class="token operator">&gt;</span> <span class="token keyword">where</span> <span class="token builtin">SectionIdentifierType</span> <span class="token punctuation">:</span> <span class="token builtin">Hashable</span><span class="token punctuation">,</span> <span class="token builtin">ItemIdentifierType</span> <span class="token punctuation">:</span> <span class="token builtin">Hashable</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建 snapshot 有两种方法</p> <ul><li>创建一个空的 snapshot， 然后通过  <code>append</code> 方法添加数据。</li> <li>通过 diffable data source 的 <code>snapshot()</code> 方法获取当前的 snapshot， 然后通过  <code>append</code> , <code>delete</code>, <code>move</code>, <code>insert</code> 方法修改数据。</li></ul> <p>介绍到在这里 <strong>Diffable Data Source</strong> 关键概念差不多介绍完了，这里整理一下流程</p> <ol><li><p><code>UITableViewDiffableDataSource</code> 负责当前数据源配置，比如配置 cell</p></li> <li><p><code>NSDiffableDataSourceSnapshot</code> 负责数据源的变更</p></li> <li><p><code>UITableViewDiffableDataSource</code>  通过调用 <code>apply</code> 方法将 <code>NSDiffableDataSourceSnapshot</code>  变更后的数据更新同步到 <code>UITableView</code>。值得注意的是为了确保 Diff 生效，所以数据必须具有唯一 Identifier，且遵循 <code>Hashable</code> 协议</p></li></ol> <h2 id="demo"><a href="#demo" class="header-anchor">#</a> Demo</h2> <p>以 <a href="https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/implementing_modern_collection_views" target="_blank" rel="noopener noreferrer">Implementing Modern Collection Views<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中的 Wifi Setting 为例</p> <p><img src="/assets/img/220-2.91087095.png" alt=""></p> <ol><li>定义 <code>UITableViewDiffableDataSource</code>，配置 cell</li></ol> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code> <span class="token keyword">self</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> <span class="token builtin">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token builtin">Section</span><span class="token punctuation">,</span> <span class="token builtin">Item</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tableView<span class="token punctuation">:</span> tableView<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span>
                <span class="token punctuation">(</span>tableView<span class="token punctuation">:</span> <span class="token builtin">UITableView</span><span class="token punctuation">,</span> indexPath<span class="token punctuation">:</span> <span class="token builtin">IndexPath</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token builtin">Item</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">UITableViewCell</span><span class="token operator">?</span> <span class="token keyword">in</span>
  
  <span class="token keyword">let</span> cell <span class="token operator">=</span> tableView<span class="token punctuation">.</span><span class="token function">dequeueReusableCell</span><span class="token punctuation">(</span>
    withIdentifier<span class="token punctuation">:</span> <span class="token builtin">WiFiSettingsViewController</span><span class="token punctuation">.</span>reuseIdentifier<span class="token punctuation">,</span>
    <span class="token keyword">for</span><span class="token punctuation">:</span> indexPath<span class="token punctuation">)</span>
  <span class="token comment">// 配置 cell</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> cell
<span class="token punctuation">}</span>
<span class="token keyword">self</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span>defaultRowAnimation <span class="token operator">=</span> <span class="token punctuation">.</span>fade
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>关于 Section, Item 的定义，关键一点是要遵从  <code>Hashable</code> 协议</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token comment">// 没有 associated 值的枚举类型自动遵从 Hashable 协议</span>
<span class="token keyword">enum</span> <span class="token builtin">Section</span><span class="token punctuation">:</span> <span class="token builtin">CaseIterable</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> config<span class="token punctuation">,</span> networks
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token builtin">Item</span><span class="token punctuation">:</span> <span class="token builtin">Hashable</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> title<span class="token punctuation">:</span> <span class="token builtin">String</span>
  <span class="token keyword">let</span> type<span class="token punctuation">:</span> <span class="token builtin">ItemType</span>
  <span class="token keyword">let</span> network<span class="token punctuation">:</span> <span class="token builtin">WiFiController</span><span class="token punctuation">.</span><span class="token builtin">Network</span><span class="token operator">?</span>
  <span class="token keyword">private</span> <span class="token keyword">let</span> identifier<span class="token punctuation">:</span> <span class="token constant">UUID</span>

  <span class="token comment">// 实现 Hashable 协议</span>
  <span class="token keyword">func</span> <span class="token function">hash</span><span class="token punctuation">(</span>into hasher<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token builtin">Hasher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hasher<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>identifier<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="2"><li>定义 <code>NSDiffableDataSourceSnapshot</code>，负责数据源的变更</li></ol> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">let</span> configItems <span class="token operator">=</span> configurationItems<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token punctuation">{</span> <span class="token operator">!</span><span class="token punctuation">(</span>$<span class="token number">0</span><span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token punctuation">.</span>currentNetwork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>controller<span class="token punctuation">.</span>wifiEnabled<span class="token punctuation">)</span> <span class="token punctuation">}</span>
currentSnapshot <span class="token operator">=</span> <span class="token builtin">NSDiffableDataSourceSnapshot</span><span class="token operator">&lt;</span><span class="token builtin">Section</span><span class="token punctuation">,</span> <span class="token builtin">Item</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
currentSnapshot<span class="token punctuation">.</span><span class="token function">appendSections</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">.</span>config<span class="token punctuation">]</span><span class="token punctuation">)</span>
currentSnapshot<span class="token punctuation">.</span><span class="token function">appendItems</span><span class="token punctuation">(</span>configItems<span class="token punctuation">,</span> toSection<span class="token punctuation">:</span> <span class="token punctuation">.</span>config<span class="token punctuation">)</span>

<span class="token keyword">if</span> controller<span class="token punctuation">.</span>wifiEnabled <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sortedNetworks <span class="token operator">=</span> controller<span class="token punctuation">.</span>availableNetworks<span class="token punctuation">.</span><span class="token builtin">sorted</span> <span class="token punctuation">{</span> $<span class="token number">0</span><span class="token punctuation">.</span>name <span class="token operator">&lt;</span> $<span class="token number">1</span><span class="token punctuation">.</span>name <span class="token punctuation">}</span>
  <span class="token keyword">let</span> networkItems <span class="token operator">=</span> sortedNetworks<span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> <span class="token function">Item</span><span class="token punctuation">(</span>network<span class="token punctuation">:</span> $<span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
  currentSnapshot<span class="token punctuation">.</span><span class="token function">appendSections</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">.</span>networks<span class="token punctuation">]</span><span class="token punctuation">)</span>
  currentSnapshot<span class="token punctuation">.</span><span class="token function">appendItems</span><span class="token punctuation">(</span>networkItems<span class="token punctuation">,</span> toSection<span class="token punctuation">:</span> <span class="token punctuation">.</span>networks<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="3"><li>调用 <code>apply</code> 方法将 <code>NSDiffableDataSourceSnapshot</code>  变更后的数据更新同步到 <code>UITableView</code></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code> self.dataSource.apply(currentSnapshot, animatingDifferences: animated)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="其它方面"><a href="#其它方面" class="header-anchor">#</a> 其它方面</h2> <ol><li><p>使用 <code>apply</code> 方法，不要再使用老就 <code>performBatchUpdates</code> , <code>insertItems</code></p></li> <li><p>新的 APIs，不会在用的 indexPath，但是以前的 APIs 可能还需要它，怎么办？<code>NSDiffableDataSourceSnapshot</code> 提供了很多转换方法</p></li> <li><p><code>apply</code> 方法运行很快，时间复杂度是O(N)</p></li> <li><p><code>apply</code> 方法可以在后台线程里安全的运行，当数据很多很多时，可以在后台线程里运行 <code>apply</code> 方法</p></li> <li><p>Share Sheet 已经采用新的 APIs</p></li></ol> <h2 id="参考阅读"><a href="#参考阅读" class="header-anchor">#</a> 参考阅读</h2> <ul><li>Sample Code</li></ul> <p><a href="https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/implementing_modern_collection_views" target="_blank" rel="noopener noreferrer">Implementing Modern Collection Views<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>WWDC 2019 Session 220</li></ul> <p><a href="https://developer.apple.com/videos/play/wwdc2019/220/" target="_blank" rel="noopener noreferrer">Advances in UI Data Sources<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#data-source-使用现状" title="Data Source 使用现状">Data Source 使用现状</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#new-apis" title="New APIs">New APIs</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#demo" title="Demo">Demo</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#其它方面" title="其它方面">其它方面</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#参考阅读" title="参考阅读">参考阅读</a></div></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b07256e7.js" defer></script><script src="/assets/js/34.49b71b2c.js" defer></script><script src="/assets/js/3.276926dd.js" defer></script><script src="/assets/js/52.e6a458bb.js" defer></script>
  </body>
</html>
