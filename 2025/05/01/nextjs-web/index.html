<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Next.js 创建 Web 应用 | Study &amp; Product</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="在使用 Express 创建 Web 服务中，我们使用 Express 创建了一个 ToDo 的 Web 服务。使用 Express 时，我们需要自己处理模板（HTML）、样式（CSS）、脚本（JavaScript）、路由、错误处理等等。而 Next.js 框架已经提供了上面的这些功能，我们只要专注于业务实现。这篇文章我们将使用 Next.js 创建 Web 应用，看看它能否帮助快速开发。">
    <meta name="algolia-site-verification" content="23333450F18E92C1">
    
    <link rel="preload" href="/assets/css/0.styles.cd1f7b12.css" as="style"><link rel="preload" href="/assets/js/app.b07256e7.js" as="script"><link rel="preload" href="/assets/js/34.49b71b2c.js" as="script"><link rel="preload" href="/assets/js/3.276926dd.js" as="script"><link rel="preload" href="/assets/js/6.6878fac4.js" as="script"><link rel="prefetch" href="/assets/js/10.7c5bc6fc.js"><link rel="prefetch" href="/assets/js/100.f675d046.js"><link rel="prefetch" href="/assets/js/101.92ede1ec.js"><link rel="prefetch" href="/assets/js/102.678a907d.js"><link rel="prefetch" href="/assets/js/103.959ad108.js"><link rel="prefetch" href="/assets/js/104.b15677eb.js"><link rel="prefetch" href="/assets/js/105.377da8a5.js"><link rel="prefetch" href="/assets/js/106.29a8c44d.js"><link rel="prefetch" href="/assets/js/107.64b19904.js"><link rel="prefetch" href="/assets/js/108.a3e75a67.js"><link rel="prefetch" href="/assets/js/109.283d92d8.js"><link rel="prefetch" href="/assets/js/11.e6a0311f.js"><link rel="prefetch" href="/assets/js/110.cbb6ea81.js"><link rel="prefetch" href="/assets/js/111.252f143f.js"><link rel="prefetch" href="/assets/js/112.df62c9fe.js"><link rel="prefetch" href="/assets/js/113.66189350.js"><link rel="prefetch" href="/assets/js/114.890cd7de.js"><link rel="prefetch" href="/assets/js/115.53823707.js"><link rel="prefetch" href="/assets/js/116.caaa6eaa.js"><link rel="prefetch" href="/assets/js/117.b7b0f88f.js"><link rel="prefetch" href="/assets/js/118.03168974.js"><link rel="prefetch" href="/assets/js/119.90f4d7b7.js"><link rel="prefetch" href="/assets/js/12.8da07182.js"><link rel="prefetch" href="/assets/js/120.b654e5ee.js"><link rel="prefetch" href="/assets/js/121.92d87086.js"><link rel="prefetch" href="/assets/js/13.a9f90626.js"><link rel="prefetch" href="/assets/js/14.b18d5210.js"><link rel="prefetch" href="/assets/js/15.835c7671.js"><link rel="prefetch" href="/assets/js/16.eb29ed80.js"><link rel="prefetch" href="/assets/js/17.c4871518.js"><link rel="prefetch" href="/assets/js/18.606b879c.js"><link rel="prefetch" href="/assets/js/19.777086a8.js"><link rel="prefetch" href="/assets/js/20.c8e69fcc.js"><link rel="prefetch" href="/assets/js/21.6cda2658.js"><link rel="prefetch" href="/assets/js/22.19e356e1.js"><link rel="prefetch" href="/assets/js/23.ca8661ea.js"><link rel="prefetch" href="/assets/js/24.9f090eaf.js"><link rel="prefetch" href="/assets/js/25.be2c8a0c.js"><link rel="prefetch" href="/assets/js/26.5ce52eaa.js"><link rel="prefetch" href="/assets/js/27.d75e1151.js"><link rel="prefetch" href="/assets/js/28.6863d7e4.js"><link rel="prefetch" href="/assets/js/29.d8a1c4f2.js"><link rel="prefetch" href="/assets/js/30.178b8dc0.js"><link rel="prefetch" href="/assets/js/31.4c488d0e.js"><link rel="prefetch" href="/assets/js/32.ce3ae3c7.js"><link rel="prefetch" href="/assets/js/33.828dd0d1.js"><link rel="prefetch" href="/assets/js/35.9496ed4c.js"><link rel="prefetch" href="/assets/js/36.33ada8e1.js"><link rel="prefetch" href="/assets/js/37.e9705ffe.js"><link rel="prefetch" href="/assets/js/38.f9c57096.js"><link rel="prefetch" href="/assets/js/39.75b77f83.js"><link rel="prefetch" href="/assets/js/4.c651aa9d.js"><link rel="prefetch" href="/assets/js/40.4496a5db.js"><link rel="prefetch" href="/assets/js/41.260393e3.js"><link rel="prefetch" href="/assets/js/42.083f9350.js"><link rel="prefetch" href="/assets/js/43.8d311a8e.js"><link rel="prefetch" href="/assets/js/44.df55763b.js"><link rel="prefetch" href="/assets/js/45.e19037c7.js"><link rel="prefetch" href="/assets/js/46.9529f37b.js"><link rel="prefetch" href="/assets/js/47.8d631e39.js"><link rel="prefetch" href="/assets/js/48.3acad59c.js"><link rel="prefetch" href="/assets/js/49.9a12a900.js"><link rel="prefetch" href="/assets/js/5.373c53f3.js"><link rel="prefetch" href="/assets/js/50.f30877b8.js"><link rel="prefetch" href="/assets/js/51.e8b2adf9.js"><link rel="prefetch" href="/assets/js/52.e6a458bb.js"><link rel="prefetch" href="/assets/js/53.e4027d0c.js"><link rel="prefetch" href="/assets/js/54.5a4be38d.js"><link rel="prefetch" href="/assets/js/55.924ee4f8.js"><link rel="prefetch" href="/assets/js/56.11ff1ccf.js"><link rel="prefetch" href="/assets/js/57.14327960.js"><link rel="prefetch" href="/assets/js/58.cea182b0.js"><link rel="prefetch" href="/assets/js/59.2db874c7.js"><link rel="prefetch" href="/assets/js/60.e3e4017b.js"><link rel="prefetch" href="/assets/js/61.d5cd385e.js"><link rel="prefetch" href="/assets/js/62.6929f93f.js"><link rel="prefetch" href="/assets/js/63.3f8bf719.js"><link rel="prefetch" href="/assets/js/64.e89e1572.js"><link rel="prefetch" href="/assets/js/65.a4335c65.js"><link rel="prefetch" href="/assets/js/66.cc9fb484.js"><link rel="prefetch" href="/assets/js/67.d5da8f2f.js"><link rel="prefetch" href="/assets/js/68.91a38f6d.js"><link rel="prefetch" href="/assets/js/69.800ca600.js"><link rel="prefetch" href="/assets/js/7.6f2558ea.js"><link rel="prefetch" href="/assets/js/70.f7b16ee7.js"><link rel="prefetch" href="/assets/js/71.e34929dc.js"><link rel="prefetch" href="/assets/js/72.175a64bf.js"><link rel="prefetch" href="/assets/js/73.c3dcfd4b.js"><link rel="prefetch" href="/assets/js/74.65978082.js"><link rel="prefetch" href="/assets/js/75.718d5152.js"><link rel="prefetch" href="/assets/js/76.2ed620b3.js"><link rel="prefetch" href="/assets/js/77.f8726387.js"><link rel="prefetch" href="/assets/js/78.1dea2e59.js"><link rel="prefetch" href="/assets/js/79.f62213a1.js"><link rel="prefetch" href="/assets/js/8.81ebcef8.js"><link rel="prefetch" href="/assets/js/80.7600ac29.js"><link rel="prefetch" href="/assets/js/81.ab94746f.js"><link rel="prefetch" href="/assets/js/82.26baf7f8.js"><link rel="prefetch" href="/assets/js/83.89a3942a.js"><link rel="prefetch" href="/assets/js/84.1a5577ac.js"><link rel="prefetch" href="/assets/js/85.eb62de22.js"><link rel="prefetch" href="/assets/js/86.7635121c.js"><link rel="prefetch" href="/assets/js/87.5bee4d72.js"><link rel="prefetch" href="/assets/js/88.04d56860.js"><link rel="prefetch" href="/assets/js/89.09a7d920.js"><link rel="prefetch" href="/assets/js/9.7f69b9b1.js"><link rel="prefetch" href="/assets/js/90.dac6a66e.js"><link rel="prefetch" href="/assets/js/91.14f101dd.js"><link rel="prefetch" href="/assets/js/92.d398eb09.js"><link rel="prefetch" href="/assets/js/93.7a5477fa.js"><link rel="prefetch" href="/assets/js/94.c4bf7674.js"><link rel="prefetch" href="/assets/js/95.a0c3c94c.js"><link rel="prefetch" href="/assets/js/96.c3a44db5.js"><link rel="prefetch" href="/assets/js/97.6956ed39.js"><link rel="prefetch" href="/assets/js/98.ad65fe08.js"><link rel="prefetch" href="/assets/js/99.4fe76e2f.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.cb5d1302.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cd1f7b12.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Study &amp; Product </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/notebook/" class="nav-link">Notebook</a></li><li class="nav-item"><a href="/about/" class="nav-link">About</a></li><li class="nav-item"><a href="https://github.com/cp3hnu" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Study &amp; Product </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/notebook/" class="nav-link">Notebook</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About</a></li><li class="mobile-nav-item"><a href="https://github.com/cp3hnu" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper blog-page"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div itemprop="articleBody" class="content__default"><h1 id="使用-next-js-创建-web-应用"><a href="#使用-next-js-创建-web-应用" class="header-anchor">#</a> 使用 Next.js 创建 Web 应用</h1> <p>在 <a href="/2025/01/17/express-web/">使用 Express 创建 Web 服务</a> 中，我们使用 Express 创建了一个 ToDo 的 Web 服务。使用 Express 时，我们需要自己处理模板（HTML）、样式（CSS）、脚本（JavaScript）、路由、错误处理等等。而 Next.js 框架已经提供了上面的这些功能，我们只要专注于业务实现。这篇文章我们将使用 Next.js 创建 Web 应用，看看它能否帮助我们实现快速开发。</p> <h2 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h2> <p>和 <a href="/2025/01/17/express-web/">使用 Express 创建 Web 服务</a> 一样，我们实现一个 Todo Web 应用</p> <h3 id="设计稿"><a href="#设计稿" class="header-anchor">#</a> 设计稿</h3> <p>ToDo 应用的主要功能如下：</p> <h4 id="注册"><a href="#注册" class="header-anchor">#</a> 注册</h4> <p><img src="/assets/img/express-web-todos-sign-up.b6eda27e.png" alt=""></p> <h4 id="登录"><a href="#登录" class="header-anchor">#</a> 登录</h4> <p><img src="/assets/img/express-web-todos-sign-in.53f32826.png" alt=""></p> <h4 id="任务列表"><a href="#任务列表" class="header-anchor">#</a> 任务列表</h4> <p><img src="/assets/img/express-web-todos-tasks.f794f952.png" alt=""></p> <h2 id="创建项目"><a href="#创建项目" class="header-anchor">#</a> 创建项目</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ npx create-next-app@latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>当前版本 15.3.0</p> <p>要求 Node.js 18.18+</p></blockquote> <p>安装的过程中，Next.js 会提供以下选项供您选择</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>What is your project named? nextjs-todo
Would you like to use TypeScript? Yes
Would you like to use ESLint? Yes
Would you like to use Tailwind CSS? Yes
Would you like your code inside a `src/` directory? Yes
Would you like to use App Router? (recommended) Yes
Would you like to use Turbopack for `next dev`?  Yes
Would you like to customize the import alias (`@/*` by default)? No
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Next.js 自动为我配置了 Typescript、ESLint、Tailwind CSS、Turbopack、Alias 和路由机制，并且代码放入 <code>src</code> 目录。</p> <h2 id="项目结构"><a href="#项目结构" class="header-anchor">#</a> 项目结构</h2> <p><code>src</code> 目录下的文件结构如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>├── app
|  ├── (pages) 
|  |  ├── (main)
|  |  |  ├── layout.tsx  // 左菜单右内容的布局 
|  |  |  ├── sider.tsx   // 左侧菜单
|  |  |  └── tasks
|  |  |     ├── components
|  |  |     |  └── TaskList.tsx
|  |  |     ├── error.tsx  // 任务错误页
|  |  |     └── page.tsx   // 任务页面
|  |  ├── login
|  |  |  └── page.tsx // 登录页面
|  |  └── register
|  |     └── page.tsx // 注册页面
|  ├── action
|  |  └── index.ts // server action
|  ├── api
|  |  └── tasks
|  |     └── route.ts // get tasks api
|  ├── db
|  |  └── index.ts  // 数据库操作
|  ├── globals.css  // 全局样式
|  ├── layout.tsx   // 根布局
|  ├── route.ts     // 根页面
|  ├── types
|  |  └── index.ts  // ts 类型
|  └── utils
|     ├── dal.ts      //  Data Access Layer
|     ├── index.ts    // 工具类
|     └── session.ts  // session 管理
└── middleware.ts       // 授权中间件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="注册-2"><a href="#注册-2" class="header-anchor">#</a> 注册</h2> <h3 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h3> <p>注册用户，需要使用数据库。为了后面部署到 <a href="https://vercel.com/" target="_blank" rel="noopener noreferrer">Vercel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这次我们使用 <a href="https://www.postgresql.org/" target="_blank" rel="noopener noreferrer">PostgreSQL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h4> <p>首先安装 <a href="https://github.com/porsager/postgres" target="_blank" rel="noopener noreferrer"><code>postgres</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <blockquote><p>也可以使用 <a href="https://github.com/brianc/node-postgres" target="_blank" rel="noopener noreferrer">node-postgres<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">npm</span> i postgres
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="创建数据库"><a href="#创建数据库" class="header-anchor">#</a> 创建数据库</h4> <p>首先安装 PostgreSQL。安装 PostgreSQL 有多种方式：</p> <blockquote><p>更多详情请参考 <a href="https://www.postgresql.org/download/macosx/" target="_blank" rel="noopener noreferrer">macOS packages<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <ul><li>Interactive installer by EDB</li> <li>Postgres.app</li> <li>Homebrew</li></ul> <p>我使用的是第一种方式 Interactive installer by EDB，功能更强大。</p> <blockquote><p>PostgreSQL 当前版本  17.2</p></blockquote> <p>安装好之后就可以创建 PostgreSQL 数据库了</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ createdb mydb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="创建数据库表"><a href="#创建数据库表" class="header-anchor">#</a> 创建数据库表</h4> <p>首先创建环境变量文件 <code>.env</code>，定义连接 PostgreSQL 数据库的选项</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB_HOST=&quot;localhost&quot;
DB_PORT=&quot;5432&quot;
DB_USER=&quot;cp3hnu&quot;
DB_PASSWORD=&quot;123456&quot;
DB_NAME=&quot;mydb&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后连接数据库并创建表</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/app/db/index.ts</span>
<span class="token keyword">import</span> postgres <span class="token keyword">from</span> <span class="token string">&quot;postgres&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token function">postgres</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_HOST</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_PORT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  database<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_NAME</span><span class="token punctuation">,</span>
  username<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_USER</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_PASSWORD</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> sql<span class="token punctuation">;</span>

<span class="token comment">// create user table</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createUserTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> sql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    CREATE TABLE IF NOT EXISTS users (
      id SERIAL PRIMARY KEY,
      username VARCHAR(50) UNIQUE NOT NULL,
      email VARCHAR(255) UNIQUE NOT NULL,
      password VARCHAR(255) NOT NULL,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// create task table</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createTaskTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> sql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    CREATE TABLE IF NOT EXISTS tasks (
      id SERIAL PRIMARY KEY,
      user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
      title VARCHAR(255) NOT NULL,
      description TEXT,
      completed BOOLEAN DEFAULT FALSE,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>创建数据库表不是 Web 应用程序的一部分，我们应该先创建好。可以使用专门的数据库管理工具创建，也可以像我这样使用 ts 代码创建</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ tsx src/app/db/index.ts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="注册用户"><a href="#注册用户" class="header-anchor">#</a> 注册用户</h3> <h4 id="创建-server-action"><a href="#创建-server-action" class="header-anchor">#</a> 创建 Server Action</h4> <ol><li>验证用户名、邮箱、密码字段</li> <li>判断用户名、邮箱是否已被注册</li> <li>使用 <a href="https://github.com/dcodeIO/bcrypt.js" target="_blank" rel="noopener noreferrer"><code>bcrypt.js</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或者 <a href="https://github.com/Mister-Hope/bcrypt-ts" target="_blank" rel="noopener noreferrer"><code>bcrypt-ts</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 加密密码</li> <li>插入一条用户记录到数据库</li></ol> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/app/action/index.ts</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">register</span><span class="token punctuation">(</span>
  _prevState<span class="token operator">:</span> RegisterFormState <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  formData<span class="token operator">:</span> FormData
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RegisterFormState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> email <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// 1. 验证用户名、邮箱、密码字段</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>username <span class="token operator">||</span> <span class="token operator">!</span>email <span class="token operator">||</span> <span class="token operator">!</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&quot;所有字段都是必填的&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>password<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&quot;密码长度不能少于6位&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 2. 判断用户名、邮箱是否已被注册</span>
  <span class="token keyword">const</span> existingUsername <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">dbGetUserByUsername</span><span class="token punctuation">(</span>
    username
  <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> DBUser <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingUsername<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&quot;用户名已存在&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> existingEmail <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">dbGetUserByEmail</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> DBUser <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingEmail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&quot;邮箱已被注册&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 3. 加密密码</span>
    <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. 插入一条用户记录到数据库</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">dbInsertUser</span><span class="token punctuation">(</span>
      username<span class="token punctuation">,</span>
      email<span class="token punctuation">,</span>
      hashedPassword
    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> DBUser<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&quot;注册成功，即将跳转到登录页&quot;</span><span class="token punctuation">,</span>
      user
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error registering user:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&quot;注册失败&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h4 id="页面"><a href="#页面" class="header-anchor">#</a> 页面</h4> <p>使用 <code>useActionState</code> 注册用户</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> register <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/app/action&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useActionState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RegisterPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> formAction<span class="token punctuation">,</span> isPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useActionState</span><span class="token punctuation">(</span>register<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>space-y-6<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>formAction<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>页面源代码，请参考 <a href="https://github.com/cp3hnu/nextjs-todo/blob/main/src/app/(pages)/register/page.tsx" target="_blank" rel="noopener noreferrer">register source code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="登录-2"><a href="#登录-2" class="header-anchor">#</a> 登录</h2> <p>登录功能主要包括验证用户、创建 Session 以及授权，整体流程如下：</p> <p><img src="/assets/img/nextjs-authentication-overview.1f7a55bd.jpeg" alt=""></p> <h3 id="用户验证"><a href="#用户验证" class="header-anchor">#</a> 用户验证</h3> <h4 id="创建-server-action-2"><a href="#创建-server-action-2" class="header-anchor">#</a> 创建 Server Action</h4> <ol><li>验证用户名、密码字段</li> <li>判断用户是否存在</li> <li>验证密码是否正确</li> <li>创建 session</li></ol> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/app/action/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createSession <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@app/utils/session&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span>
  _prevState<span class="token operator">:</span> RegisterFormState <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  formData<span class="token operator">:</span> FormData
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 1. 验证用户名、密码字段</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>username <span class="token operator">||</span> <span class="token operator">!</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&quot;用户名和密码都是必填的&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 2. 判断用户是否存在</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">dbGetUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> DBUser<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&quot;用户不存在&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 3. 验证密码是否正确</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">&quot;密码错误&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 4. 创建 Session</span>
  <span class="token keyword">await</span> <span class="token function">createSession</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 登录成功，返回用户信息</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    user<span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">&quot;登录成功，即将跳转到任务列表页&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h4 id="页面-2"><a href="#页面-2" class="header-anchor">#</a> 页面</h4> <p>使用 <code>useActionState</code> 登录用户</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> login <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/app/action&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useActionState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RegisterPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> formAction<span class="token punctuation">,</span> isPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useActionState</span><span class="token punctuation">(</span>login<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>space-y-6<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>formAction<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>页面源代码，请参考 <a href="https://github.com/cp3hnu/nextjs-todo/blob/main/src/app/(pages)/login/page.tsx" target="_blank" rel="noopener noreferrer">login source code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="session-管理"><a href="#session-管理" class="header-anchor">#</a> Session 管理</h3> <p>我们通过 session 来验证用户，Next.js 文档说 Session 有<a href="https://nextjs.org/docs/app/guides/authentication#session-management" target="_blank" rel="noopener noreferrer">两种类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <ul><li><strong>Stateless</strong>: session 存储在浏览器的 cookie 中。cookie 随每个请求一起发送给服务器，然后服务器验证 session。这种方法简单，但是安全性低一点。</li> <li><strong>Database</strong>: session 存储在数据库中，只是把加密的 session ID 存储在浏览器的 cookie 中。这种方法更安全，但比较复杂，会使用更多的服务器资源。</li></ul> <p>这里我们使用 Stateless 类型，并且使用 <a href="https://github.com/panva/jose" target="_blank" rel="noopener noreferrer"><code>Jose</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来创建和管理 session</p> <h4 id="安装-jose"><a href="#安装-jose" class="header-anchor">#</a> 安装 Jose</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">npm</span> i jose
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="创建-session"><a href="#创建-session" class="header-anchor">#</a> 创建 Session</h4> <ol><li>首先用 openSSL 生成一个 secret key</li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ openssl rand -base64 <span class="token number">32</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>然后将 secret key 存放到 <code>.env</code></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>SESSION_SECRET=&quot;...&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>使用 <a href="https://github.com/panva/jose" target="_blank" rel="noopener noreferrer"><code>Jose</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来生成与验证 JWT</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/app/utils/session.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SignJWT<span class="token punctuation">,</span> type JWTPayload <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;jose&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> secretKey <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SESSION_SECRET</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> encodedKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token parameter">payload<span class="token operator">:</span> JWTPayload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SignJWT</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setProtectedHeader</span><span class="token punctuation">(</span><span class="token punctuation">{</span> alg<span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setExpirationTime</span><span class="token punctuation">(</span><span class="token string">&quot;7d&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>encodedKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>session<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> payload <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">jwtVerify</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> encodedKey<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      algorithms<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;HS256&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> payload<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to verify session&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ol start="4"><li>用 <code>userId</code> 创建 session，并存储到 cookie</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/app/utils/session.ts</span>
<span class="token keyword">const</span> Expires <span class="token operator">=</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 7 days in milliseconds</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSession</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> expiresAt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> Expires<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token punctuation">{</span> userId<span class="token punctuation">,</span> expiresAt <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cookieStore <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  cookieStore<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;session&quot;</span><span class="token punctuation">,</span> session<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    secure<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    expires<span class="token operator">:</span> expiresAt<span class="token punctuation">,</span>
    sameSite<span class="token operator">:</span> <span class="token string">&quot;lax&quot;</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">&quot;/&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="授权"><a href="#授权" class="header-anchor">#</a> 授权</h3> <p>在用户登录之后，可以根据用户权限或角色显示不同的内容。</p> <p>我们使用中间件来进行授权。</p> <ol><li>检查当前路由是否为保护路由或公共路由</li> <li>获取 cookie，如果没有找到 cookie，则将其视为未通过身份验证</li> <li>从 cookie 中解密 session</li> <li>如果用户未经过身份验证，则重定向到 <code>/login</code></li> <li>如果用户通过身份验证，则重定向到 <code>/tasks</code></li></ol> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/middleware.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NextRequest<span class="token punctuation">,</span> NextResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;next/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> decrypt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/app/utils/session&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cookies <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;next/headers&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> publicRoutes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/register&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span>req<span class="token operator">:</span> NextRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 检查当前路由是否为保护路由或公共路由</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> req<span class="token punctuation">.</span>nextUrl<span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isPublicRoute <span class="token operator">=</span> publicRoutes<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isProtectedRoute <span class="token operator">=</span> <span class="token operator">!</span>isPublicRoute<span class="token punctuation">;</span>

  <span class="token comment">// 2. 获取 cookie</span>
  <span class="token keyword">const</span> cookie <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;session&quot;</span><span class="token punctuation">)</span><span class="token operator">?.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果没有找到 cookie，则将其视为未通过身份验证</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isProtectedRoute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>nextUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3. 从 cookie 中解密 session</span>
  <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 4. 如果用户未经过身份验证，则重定向到 `/login`</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isProtectedRoute <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>session<span class="token operator">?.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>nextUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 5. 如果用户通过身份验证，则重定向到 `/tasks`</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isPublicRoute <span class="token operator">&amp;&amp;</span> session<span class="token operator">?.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span><span class="token string">&quot;/tasks&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>nextUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Routes Middleware should not run on</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  matcher<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/((?!api|_next/static|_next/image|.*\\.png$).*)&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="data-access-layer-dal"><a href="#data-access-layer-dal" class="header-anchor">#</a> Data Access Layer (DAL)</h3> <p>Next.js 推荐创建一个 <a href="https://nextjs.org/docs/app/guides/authentication#creating-a-data-access-layer-dal" target="_blank" rel="noopener noreferrer">DAL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 处理用户与应用程序交互时验证用户的 session。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token string">&quot;server-only&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> cookies <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;next/headers&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> decrypt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/app/utils/session&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cache <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;next/navigation&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> verifySession <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cookie <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;session&quot;</span><span class="token punctuation">)</span><span class="token operator">?.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token operator">?.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> isAuth<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> userId<span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="任务"><a href="#任务" class="header-anchor">#</a> 任务</h2> <p>任务模块是最常见，也最具代表性的增删改查操作。</p> <h3 id="数据库表操作"><a href="#数据库表操作" class="header-anchor">#</a> 数据库表操作</h3> <p>首先用 <a href="https://github.com/porsager/postgres" target="_blank" rel="noopener noreferrer"><code>postgres</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 实现数据库表的增删改查操作</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/app/db/index.ts</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">dbGetTasks</span><span class="token punctuation">(</span>
  userId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  title<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>DBTask<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> titleQuery <span class="token operator">=</span> title <span class="token operator">?</span> sql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">AND title ILIKE </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> sql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> orderBy <span class="token operator">=</span> sql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ORDER BY completed DESC, 
      CASE WHEN completed THEN updated_at END DESC, 
      CASE WHEN NOT completed THEN created_at END ASC;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> sql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      SELECT * FROM tasks WHERE user_id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>titleQuery<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>orderBy<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Fetched tasks:&quot;</span><span class="token punctuation">,</span> title<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result <span class="token keyword">as</span> <span class="token builtin">unknown</span> <span class="token keyword">as</span> DBTask<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error fetching tasks by user ID:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">dbInsertTask</span><span class="token punctuation">(</span>
  userId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  title<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>DBTask<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> sql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      INSERT INTO tasks (user_id, title)
      VALUES (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
      RETURNING *
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> DBTask<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error inserting task:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">dbUpdateTask</span><span class="token punctuation">(</span>
  taskId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  updates<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> completed<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>DBTask<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dbUpdates <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>updates<span class="token punctuation">,</span>
    updated_at<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Ensure updated_at is always set</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> sql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      UPDATE tasks
      SET </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">sql</span><span class="token punctuation">(</span>dbUpdates<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      WHERE id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>taskId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      RETURNING *
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> DBTask<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error updating task:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">dbDeleteTask</span><span class="token punctuation">(</span>taskId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> sql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      DELETE FROM tasks WHERE id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>taskId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> taskId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error deleting task:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><h3 id="server-actions"><a href="#server-actions" class="header-anchor">#</a> Server Actions</h3> <p>接下来创建 server action</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 获取任务列表</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getTasks</span><span class="token punctuation">(</span>title<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>DBTask<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> userId <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">verifySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;用户未登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tasks <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">dbGetTasks</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tasks<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error fetching tasks:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;获取任务列表失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 插入、更新、删除类似，都是首先验证 session，然后调用数据库表操作</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addTask</span><span class="token punctuation">(</span>title<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>DBTask <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span>  <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateTask</span><span class="token punctuation">(</span>
  taskId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  content<span class="token operator">:</span> <span class="token punctuation">{</span> completed<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span> title<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>DBTask<span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deleteTask</span><span class="token punctuation">(</span>taskId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="页面-3"><a href="#页面-3" class="header-anchor">#</a> 页面</h3> <p>最后实现具体的功能页面</p> <h4 id="服务器组件-vs-客户端组件"><a href="#服务器组件-vs-客户端组件" class="header-anchor">#</a> 服务器组件 vs 客户端组件</h4> <p>使用 Next.js 时，我们应该优先考虑服务器组件，因为服务器组件具有以下优势：</p> <ul><li><strong>获取数据更快</strong>：服务器组件和数据源都在服务器上，因此获取数据更快。</li> <li><strong>更安全</strong>：服务器组件将敏感数据保存在服务器上，不会暴露给客户端，因此更安全。</li> <li><strong>缓存</strong>：服务器组件渲染的内容能被缓存，可以提高性能。</li> <li><strong>减少客户端 JavaScript 包大小</strong>：服务器组件在服务器上运行，因此客户端需要下载、解析和执行的 JavaScript 减少。</li> <li><strong>初始页面加载和第一次内容绘制（FCP）速度更快</strong>：服务器组件在服务器上生成 HTML 以允许用户立即查看页面，而无需等待客户端下载、解析和执行渲染页面所需的 JavaScript，因此初始页面加载和第一次内容绘制（FCP）速度更快。</li> <li><strong>搜索引擎优化和社交网络可共享性</strong>：服务器组件生成的 HTML 可以被搜索引擎机器人访问、被社交网络机器人用于生成社交卡。</li> <li><strong>流式</strong>：服务器组件可以将渲染分割成块，然后将它们流式传输到客户端，这可以使用户更早地看到页面的部分内容。</li></ul> <p>但是服务器组件也不是万能的，服务器组件不能有事件处理函数，而且交互体验不如客户端组件。</p> <p>因为任务页面涉及增删改查操作，必然需要事件处理函数（也可以使用 form + action 的方式，这样就可以使用服务器组件，但是体验不是很好），因此需要使用客户端组件。但是我们可以拆解，使用事件处理函数的部分使用客户端组件，其它的使用服务器组件。</p> <p>查询任务列表我们使用服务器组件，新增、修改和删除使用客户端组件。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// src/app/(pages)/(main)/tasks/page.tsx</span>
<span class="token keyword">import</span> TaskList <span class="token keyword">from</span> <span class="token string">&quot;./components/TaskList&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getTasks <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/app/action&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PageProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/app/types&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">TasksPage</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> searchParams <span class="token punctuation">}</span><span class="token operator">:</span> PageProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _searchParams <span class="token operator">=</span> <span class="token keyword">await</span> searchParams<span class="token punctuation">;</span>
  <span class="token keyword">const</span> title <span class="token operator">=</span> _searchParams<span class="token operator">?.</span>title<span class="token punctuation">;</span>
  <span class="token keyword">const</span> tasks <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getTasks</span><span class="token punctuation">(</span>title <span class="token keyword">as</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">TaskList</span></span> <span class="token attr-name">initialTasks</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>tasks<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">TaskList</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// src/app/(pages)/(main)/tasks/components/TaskList.tsx</span>
<span class="token string">&quot;use client&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> addTask<span class="token punctuation">,</span> updateTask<span class="token punctuation">,</span> deleteTask <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/app/action&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DBTask <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/app/types&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/navigation'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useSearchParams <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;next/navigation&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">TaskListProps</span> <span class="token punctuation">{</span>
  initialTasks<span class="token operator">?</span><span class="token operator">:</span> DBTask<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">TaskList</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> initialTasks<span class="token operator">:</span> tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token operator">:</span> TaskListProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>editingId<span class="token punctuation">,</span> setEditingId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>editTitle<span class="token punctuation">,</span> setEditTitle<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> searchParams <span class="token operator">=</span> <span class="token function">useSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> title <span class="token operator">=</span> searchParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token comment">// 处理新增</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleAdd</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">formData<span class="token operator">:</span> FormData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">addTask</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
      router<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 处理删除</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleDelete</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">taskId<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">deleteTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 处理完成状态切换</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleToggle</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">task<span class="token operator">:</span> DBTask</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">updateTask</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> completed<span class="token operator">:</span> <span class="token operator">!</span>task<span class="token punctuation">.</span>completed <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 处理标题修改</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleEditSave</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">task<span class="token operator">:</span> DBTask</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>editTitle<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> editTitle <span class="token operator">!==</span> task<span class="token punctuation">.</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">updateTask</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> editTitle <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">setEditingId</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setEditTitle</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 文档树结构请参考 </span>
  <span class="token comment">// https://github.com/cp3hnu/nextjs-todo/blob/main/src/app/(pages)/(main)/tasks/components/TaskList.tsx</span>
  <span class="token keyword">return</span> <span class="token operator">...</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h2 id="部署"><a href="#部署" class="header-anchor">#</a> 部署</h2> <p>我们的 Todo 应用已经构建完成，接下来我们将它部署的 <a href="https://vercel.com/" target="_blank" rel="noopener noreferrer">Vercel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <ol><li>创建 GitHub 代码仓库</li></ol> <p><img src="/assets/img/nextjs-deploy-github.27cb337d.png" alt=""></p> <ol start="2"><li>以 GitHub 代码仓库创建 Vercel Project</li></ol> <p><img src="/assets/img/nextjs-deploy-vercel-project.a0dace81.png" alt=""></p> <ol start="3"><li>在 &quot;Storage&quot;  页签创建数据库，Vercel 提供了多种数据库可供选择，我这里选择 &quot;Neon&quot;</li></ol> <p><img src="/assets/img/nextjs-deploy-storage.9919661c.png" alt=""></p> <ol start="4"><li>拷贝 <code>.env.local</code> 里的环境变量到项目的 <code>.env</code> 文件</li></ol> <p><img src="/assets/img/nextjs-deploy-env.5385acb3.png" alt=""></p> <p>这里还提供了各种库使用数据库的示例代码。</p> <ol start="5"><li><p>在 Vercel Project 里添加环境变量。选择 &quot;Setting&quot;  -&gt; &quot;Environment Variables&quot; 里添加环境变量，甚至可以通过 &quot;Import .env&quot; 导入环境变量</p> <p><img src="/assets/img/nextjs-deploy-add-env.4fdc86d8.png" alt=""></p></li> <li><p>修改连接数据库的代码，我使用的是 <code>postgres.js</code></p></li></ol> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>import postgres from &quot;postgres&quot;;

<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">const sql = postgres({
</span><span class="token prefix deleted">-</span><span class="token line">  host: process.env.DB_HOST,
</span><span class="token prefix deleted">-</span><span class="token line">  port: Number(process.env.DB_PORT),
</span><span class="token prefix deleted">-</span><span class="token line">  database: process.env.DB_NAME,
</span><span class="token prefix deleted">-</span><span class="token line">  username: process.env.DB_USER,
</span><span class="token prefix deleted">-</span><span class="token line">  password: process.env.DB_PASSWORD
</span><span class="token prefix deleted">-</span><span class="token line">});
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const sql = postgres(process.env.DATABASE_URL!, { ssl: &quot;verify-full&quot; });
</span></span>
export default sql;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="7"><li>提交代码到 GitHub 仓库，然后 Vercel 将自动构建。</li></ol> <p><img src="/assets/img/nextjs-deploy-deployments.d89a51b2.png" alt=""></p> <p>至此，成功部署到 Vercel</p> <p><img src="/assets/img/nextjs-deploy-result.0485fd4b.png" alt=""></p> <h3 id="其它事项"><a href="#其它事项" class="header-anchor">#</a> 其它事项</h3> <p>在部署的过程中，我发现每次提交代码到 GitHub，不管是不是 <code>main</code> 分支的提交，Vercel 都会进行部署，因为 Vercel 的部署分为两种 <code>Preview</code> 和 <code>Production</code>。</p> <p>提交代码到 GitHub，Vercel 都会进行 Preview 构建，它的作用是在代码合并前进行测试、验收。如果你不想进行 Preview 构建，可以在 &quot;Settings&quot; -&gt; &quot;Git&quot; -&gt; &quot;Ignored Build Step&quot; 选择 &quot;Only build production&quot;。</p> <p><img src="/assets/img/nextjs-deploy-ignore-build.59573b30.png" alt=""></p> <p>更多详情，请参考 <a href="https://vercel.com/docs/project-configuration/git-settings#ignored-build-step" target="_blank" rel="noopener noreferrer">Vercel - Ignored Build Step<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://vercel.com/guides/how-do-i-use-the-ignored-build-step-field-on-vercel" target="_blank" rel="noopener noreferrer">How do I use the &quot;Ignored Build Step&quot; field on Vercel?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>如果想控制具体哪个分支的提交才触发 Vercel 部署，还可以使用 <a href="https://vercel.com/docs/project-configuration/git-configuration#git.deploymentenabled" target="_blank" rel="noopener noreferrer"><code>git.deploymentEnabled</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 配置选项。</p> <p>比如设置 <code>dev</code> 分支上的提交不触发 Vercel 部署，设置 <code>dev: false</code></p> <blockquote><p>默认任意分支都是 <code>true</code></p></blockquote> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// vercel.json </span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;$schema&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://openapi.vercel.sh/vercel.json&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;git&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;deploymentEnabled&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="source-code"><a href="#source-code" class="header-anchor">#</a> Source Code</h2> <p><a href="https://github.com/cp3hnu/nextjs-todo" target="_blank" rel="noopener noreferrer">nextjs-todo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="应用地址"><a href="#应用地址" class="header-anchor">#</a> 应用地址</h2> <p><a href="https://nextjs-todo-liard-one.vercel.app/" target="_blank" rel="noopener noreferrer">nextjs-todo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li><a href="https://nextjs.org/" target="_blank" rel="noopener noreferrer">Next.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://nextjs.org/docs/app/guides/authentication" target="_blank" rel="noopener noreferrer">Next.js Authentication<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://nextjs.org/learn/dashboard-app/adding-authentication" target="_blank" rel="noopener noreferrer">Learn: Chapter 15 Adding Authentication<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://nextjs.org/docs/app/guides/authentication#auth-libraries" target="_blank" rel="noopener noreferrer">Auth Libraries<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Guides/Cookies" target="_blank" rel="noopener noreferrer">Using HTTP cookies<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://npmtrends.com/@auth0/nextjs-auth0-vs-@clerk/nextjs-vs-better-auth-vs-next-auth" target="_blank" rel="noopener noreferrer">NPM Trends: NextAuth.js vs Auth0 vs Clerk vs Better Auth<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://vercel.com/" target="_blank" rel="noopener noreferrer">Vercel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://vercel.com/docs/project-configuration/git-settings#ignored-build-step" target="_blank" rel="noopener noreferrer">Vercel - Ignored Build Step<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://vercel.com/guides/how-do-i-use-the-ignored-build-step-field-on-vercel" target="_blank" rel="noopener noreferrer">How do I use the &quot;Ignored Build Step&quot; field on Vercel?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://vercel.com/docs/project-configuration/git-configuration" target="_blank" rel="noopener noreferrer">Git Configuration<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.prisma.io/docs/guides/nextjs" target="_blank" rel="noopener noreferrer">How to use Prisma ORM with Next.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.postgresql.org/" target="_blank" rel="noopener noreferrer">PostgreSQL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/drizzle-team/drizzle-orm" target="_blank" rel="noopener noreferrer"><code>drizzle-orm</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/porsager/postgres" target="_blank" rel="noopener noreferrer"><code>postgres.js</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/brianc/node-postgres" target="_blank" rel="noopener noreferrer">node-postgres<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/dcodeIO/bcrypt.js" target="_blank" rel="noopener noreferrer"><code>bcrypt.js</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/Mister-Hope/bcrypt-ts" target="_blank" rel="noopener noreferrer"><code>bcrypt-ts</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/panva/jose" target="_blank" rel="noopener noreferrer"><code>Jose</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/vvo/iron-session" target="_blank" rel="noopener noreferrer"><code>iron-session</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.npmjs.com/package/use-debounce" target="_blank" rel="noopener noreferrer"><code>use-debounce</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.npmjs.com/package/server-only" target="_blank" rel="noopener noreferrer"><code>server-only</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#需求" title="需求">需求</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#设计稿" title="设计稿">设计稿</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#创建项目" title="创建项目">创建项目</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#项目结构" title="项目结构">项目结构</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#注册-2" title="注册">注册</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#数据库" title="数据库">数据库</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#注册用户" title="注册用户">注册用户</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#登录-2" title="登录">登录</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#用户验证" title="用户验证">用户验证</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#session-管理" title="Session 管理">Session 管理</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#授权" title="授权">授权</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#data-access-layer-dal" title="Data Access Layer (DAL)">Data Access Layer (DAL)</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#任务" title="任务">任务</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#数据库表操作" title="数据库表操作">数据库表操作</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#server-actions" title="Server Actions">Server Actions</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#页面-3" title="页面">页面</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#部署" title="部署">部署</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#其它事项" title="其它事项">其它事项</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#source-code" title="Source Code">Source Code</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#应用地址" title="应用地址">应用地址</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#references" title="References">References</a></div></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b07256e7.js" defer></script><script src="/assets/js/34.49b71b2c.js" defer></script><script src="/assets/js/3.276926dd.js" defer></script><script src="/assets/js/6.6878fac4.js" defer></script>
  </body>
</html>
