---
pageClass: blog-page
title: 创建 Node.js 命令行工具 
tags:
  - web
  - node
date: 2024-08-23
author: cp3hnu
location: ChangSha
summary: 创建 Node.js 命令行工具 chinesize，它使用 posthtml工具汉化 Angular 项目
---

# 创建 Node.js 命令行工具

最近又接到一个需求：汉化一个英文 Angular 项目。Angular 不是使用 JSX/TSX 来构建 UI 的，而是使用 HTML 模版来构建的，所以不能使用我上一篇文章提到的 `jscodeshift` 工具。这次我使用了 [`posthtml`](https://github.com/posthtml/posthtml)（[`cheerio`](https://github.com/cheeriojs/cheerio) 也是一个不错的选项），并且我打算创建一个 Node.js 命令行工具 **chinesize**，它将使用 [`posthtml`](https://github.com/posthtml/posthtml) 来汉化 Angular 项目。

## 汉化 Angular 项目

汉化 Angular 项目和上一篇[汉化 React 项目](./2024-08-08-jscodeshift)的整体思路是一样的，提取代码里的英文文本 -> 翻译英文文本 -> 替换代码里的英文文本，只是操作对象不一样，汉化 React 项目需要解析 JSX/TSX 文件，而汉化 Angular 项目需要解析 HTML 文件以及 Angular 模版（其本质还是 HTML），所以汉化 React 项目使用 `jscodeshift` 工具，而汉化 Angular 项目使用 `posthtml` 工具。

汉化 Angular 项目分两种情况：

- HTML 文件，直接使用 `posthtml` 工具进行汉化

- Angular 模版，需要提取模版字符串，然后汉化模版字符串，最后将汉化后的模版字符串替换原来的模版字符串，比如

```ts
@Component({
  selector: 'metrics-pinned-view-component',
  template: `
    <div class="group-toolbar">
      <div
        class="right-items"
        *ngIf="cardIdsWithMetadata.length > 0 && globalPinsEnabled"
      >
        <button
          mat-stroked-button
          aria-label="Clear all pinned cards"
          (click)="onClearAllPinsClicked.emit()"
        >
          Clear all pins
        </button>
      </div>
    </div>
    <ng-template #emptyPinnedView>
      <div class="empty-message">Pin cards for a quick view and comparison</div>
    </ng-template>
  `,
})
```

## `posthtml`

[`posthtml`](https://github.com/posthtml/posthtml) 是一个转换 HTML/XML 的工具，它只包括一个 HTML 解析器、一个 HTML 节点树 API 和一个将节点树转成字符串 API。所有的 HTML 转换都是通过插件来完成的。这些插件只是简单的 JS 函数，它们接收 HTML节点树，对其进行转换，并返回修改后的树。

它主要由两部分组成：

- [`posthtml-parser`](https://github.com/posthtml/posthtml-parser)： 解析 HTML/XML 到 PostHTMLTree
- [`posthtml-render`](https://github.com/posthtml/posthtml-render)： 渲染 PostHTMLTree 到 HTML/XML

这里主要讲一下怎么使用 [`posthtml`](https://github.com/posthtml/posthtml) 提取和替换 HTML 里的英文文本，提取和替换 Angular 模版里的英文文本类似，翻译参考上一篇[汉化 React 项目](./2024-08-08-jscodeshift)

### 提取 HTML 英文文本

```js
// 使用 posthtml 处理 HTML
function extractHtml(filePath) {
  // 读取代码文件内容
  const html = fs.readFileSync(filePath, 'utf-8');
  // 使用下面的提取英文文本插件
  posthtml([extractEnglishText()])
  .process(html) // 处理 html 
  .then((result) => {
    console.log('提取完成: ', filePath);
  })
  .catch((error) => {
    console.error('Error processing HTML:', error);
  });
}

// 提取英文文本插件
function extractEnglishText() {
  return (tree) => {
    const texts = [];
    // 排除 style、script、code、pre 标签的元素
    tree.match({ tag: /\b(?!style\b)(?!script\b)(?!code\b)(?!pre\b)\w+/ }, (node) => {
      // 文本
      const content = node.content;
      if (Array.isArray(content)) {
        content.forEach((item) => {
          addText(item, texts);
        })
      }

      // title 属性
      if (node.attrs && node.attrs.title) {
        addText(node.attrs.title, texts);
      }
      return node;
    });

    // 将提取的文本写入文件，用于后续翻译
    if (texts.length > 0) {
      const str = texts.join('，') + "，";
      fs.appendFileSync('../json/texts-to-translate-html.txt', str);
    }
  };
}

// 添加文本
function addText(value, array) {
  if (typeof value === 'string') {
    const text = value.trim();
    if (text) {
      // 去掉注释和插值文本
      const isInterpolation = text.startsWith('{{') && text.endsWith('}}');
      const isComment = text.startsWith("<!--")
      if (!isInterpolation && !isComment) {
        array.push(text);
      }
    }
  }
}
```

### 替换 HTML 英文文本

```js
import {render} from 'posthtml-render';

// 使用 posthtml 处理 HTML
// translations 是英中文翻译
function repalceHtml(filePath, translations) {
  // 读取代码文件内容
  const html = fs.readFileSync(filePath, 'utf-8');
  // 使用下面的提取英文文本插件
  posthtml([replaceEnglishText(translations)])
  .process(html, {
    recognizeNoValueAttribute: true // 如果设置为 `true`, AST 节点将识别没有值的属性并将其标记为 `true`
  })
  .then(async (result) => {
    // 使用 posthtml-render 自定义转换
    const outputHtml = render(result.tree, {
      singleTags: ['br', 'hr', 'img', 'meta', 'link', 'input'],
      closingSingleTag: 'slash',
      closeEmptyTags: true
    });
    // 将处理后的 HTML 写回文件，覆盖原文件内容
    fs.writeFileSync(filePath, outputHtml);
  })
  .catch((error) => {
    console.error('Error processing HTML:', error);
  });
}

// 替换英文文本插件
function replaceEnglishText(translations) {
  return (tree) => {
    tree.match({ tag: /\b(?!style\b)(?!script\b)(?!code\b)(?!pre\b)\w+\b/ }, (node) => {
      const content = node.content;
      // 文本
      if (Array.isArray(content)) {
        node.content = content.map((item) => {
          if (typeof item === 'string') {
            const text = item.trim();
            if (text && translations[text]) {
              return translations[text];
            }
          }
          return item;
        })
      }
      
      // title 属性
      if (node.attrs && node.attrs.title) {
        if (typeof node.attrs.title === 'string') {
          const text = node.attrs.title.trim();
          if (text && translations[text]) {
            node.attrs.title = translations[text];
          }
        }
      }
      return node;
    });
  };
}
```

## 创建 chinesize 项目



## 参数解析

process.argv





## 完整代码





## References

- [`posthtml`](https://github.com/posthtml/posthtml)
- [`cheerio`](https://github.com/cheeriojs/cheerio)
- [AST Explorer](http://astexplorer.net/)
- [How to build a CLI with Node.js](https://www.twilio.com/en-us/blog/how-to-build-a-cli-with-node-js)
- [如何使用 Node.js 构建一个命令行应用（CLI）](https://juejin.cn/post/6844903857865097229)
- [`Inquirer.js`](https://github.com/SBoudrias/Inquirer.js)
- [`commander.js`](https://github.com/tj/commander.js)
- [`yargs`](https://github.com/yargs/yargs)
- [`chalk`](https://github.com/chalk/chalk)
- [`shelljs`](https://github.com/shelljs/shelljs)
- [`isomorphic-git`](https://github.com/isomorphic-git/isomorphic-git)
- [`git-js`](https://github.com/steveukx/git-js)
- [`ink`](https://github.com/vadimdemedes/ink)
- [awesome-nodejs](https://github.com/sindresorhus/awesome-nodejs)
- [`htmlparser2`](https://github.com/fb55/htmlparser2)
- [`parse5`](https://github.com/inikulin/parse5)

