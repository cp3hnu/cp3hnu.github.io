---
pageClass: blog-page
title: Jest
tags:
  - web
  - test
date: 2023-02-16
author: cp3hnu
location: ChangSha
summary: Jest 是一款优雅、简洁的 JavaScript 测试框架，支持 React、Angular、Vue 等诸多框架。
---

# Jest

Jest 是一款优雅、简洁的 JavaScript 测试框架。同时 Jest 支持 [Babel](https://babeljs.io/)、[TypeScript](https://www.typescriptlang.org/)、[Node](https://nodejs.org/)、[React](https://reactjs.org/)、[Angular](https://angular.io/)、[Vue](https://vuejs.org/) 等诸多框架。

## 安装

```sh
$ npm install jest -D
```

添加 `test` script

```js
// package.json
{
  "scripts": {
    "test": "jest"
  }
}
```

使用 babel

```sh
$ npm install babel-jest @babel/core @babel/preset-env -D
```

新建 `babel.config.js  `文件

```js
module.exports = {
  presets: [['@babel/preset-env', {targets: {node: 'current'}}]],
};
```

## Jest 的基本流程

Jest 使用**匹配器**进行测试，例如 `toBe()`.

```js
test("adds 1 + 2 to equal 3", () => {
  expect(sum(1, 2)).toBe(3);
});
```

Jest 支持很多匹配器，详情请参考 [Expect](https://jestjs.io/docs/expect).

Jest 还可以使用 `describe()` 将多个相关的测试组合在一起，例如：

```js
describe('math', () => {
  test('add', () => {
    expect(1 + 2).toBe(3);
  });

  test('subtract', () => {
    expect(3 - 1).toBe(2);
  });
});
```

## 测试异步代码

Jest 也能测试异步代码，有三种方法：

### Return Promise

通过在测试里返回 promise，Jest 会等待 promise 完成，然后进行相应的测试。

```js
test("test promise that resolved by returning promise", () => {
  return fetchData().then(data => {
    expect(data).toBe("data");
  });
});

test("test promise that rejected by returning promise", () => {
  expect.assertions(1);
  return fetchDataWithError().catch(error => {
    expect(error).toBe("error");
  });
});
```

当测试 promise 应该 `rejected` 时，需要设置 `expect.assertions(1)`，否则当 promise `resolved` 的时候，测试是通过的。

### Async/Await

Jest 也可以使用 `async/await` 测试异步代码。

```js
test("test promise that resolved with async/await", async () => {
  const data = await fetchData();
  expect(data).toBe("data");
});

test("test promise that rejected by async/await", async () => {
  expect.assertions(1);
  try {
    await fetchDataWithError();
  } catch (error) {
    expect(error).toBe("error");
  }
});
```

同样当测试 promise 应该 `rejected` 时，需要设置 `expect.assertions(1)`.

## `resolves` / `rejects` Modifiers

结合 `async/await` 和 `.resolves` / `.rejects` 修饰符，可以很方便的测试异步代码。

```js
test("test promise that resolved by `resolves` modifier", async () => {
  await expect(fetchData()).resolves.toBe("data");
});

test("test promise that rejected with `rejects` modifier", async () => {
  await expect(fetchDataWithError()).rejects.toBe("error");
});
```

### callback

Jest 通过提供 `done` 参数来测试 callback.

```js
test("callback", done => {
  function callback(error, data) {
    if (error) {
      done(error);
      return;
    }
    try {
      expect(data).toBe("data");
      done();
    } catch (error) {
      done(error);
    }
  }
  fetchDataWithCallback(callback);
});

```

Jest 会等 `done` 回调函数被调用执行结束后，再结束测试。

## 安装和移除

写测试的时候需要在测试前做一些准备工作，Jest 提供了 `beforeEach` 和 `beforeAll` 辅助函数,

相应地需要在测试后进行一些收尾工作，Jest 提供了 `afterEach` 和 `afterAll` 辅助函数。

执行顺序如下：

```js
beforeAll(() => console.log('1 - beforeAll'));
afterAll(() => console.log('1 - afterAll'));
beforeEach(() => console.log('1 - beforeEach'));
afterEach(() => console.log('1 - afterEach'));

test('', () => console.log('1 - test'));

describe('Scoped / Nested block', () => {
  beforeAll(() => console.log('2 - beforeAll'));
  afterAll(() => console.log('2 - afterAll'));
  beforeEach(() => console.log('2 - beforeEach'));
  afterEach(() => console.log('2 - afterEach'));

  test('', () => console.log('2 - test'));
});

// 1 - beforeAll
// 1 - beforeEach
// 1 - test
// 1 - afterEach
// 2 - beforeAll
// 1 - beforeEach
// 2 - beforeEach
// 2 - test
// 2 - afterEach
// 1 - afterEach
// 2 - afterAll
// 1 - afterAll
```

当一个文件有多个 `beforeEach`，以它们定义的顺序执行；

当一个文件有多个 `afterEach` 时，以它们定义的顺序反向执行。

## 模拟函数

模拟函数允许你通过擦除函数的实际实现来测试代码之间的链接。

### 使用 mock 函数

Jest 通过 `jest.fn` 定义一个 mock 函数，来代替真正的函数，然后可以对这个 mock 函数进行测试，比如测试被调用的次数、调用时的传入的参数、函数的返回值等等。

```js
const mockCallback = jest.fn(x => 42 + x);
test('forEach mock function', () => {
  forEach([0, 1], mockCallback);

  // The mock function was called twice
  expect(mockCallback.mock.calls).toHaveLength(2);

  // The first argument of the first call to the function was 0
  expect(mockCallback.mock.calls[0][0]).toBe(0);

  // The first argument of the second call to the function was 1
  expect(mockCallback.mock.calls[1][0]).toBe(1);

  // The return value of the first call to the function was 42
  expect(mockCallback.mock.results[0].value).toBe(42);
});
```

mock 函数有一个 `mock` 属性，定义了很多与函数调用相关的属性，详情请参考 [Mock Functions](https://jestjs.io/docs/mock-function-api).

### Mock Modules

Jest 可以 mock 整个模块，例如下面的代码 mock `axios` 模块

```js {4}
import axios from 'axios';
import Users from './users';

jest.mock('axios');

test('should fetch users', () => {
  const users = [{name: 'Bob'}];
  const resp = {data: users};
  
  // 或者使用 `mockImplementation`
  // axios.get.mockImplementation(() => Promise.resolve(resp))
  axios.get.mockResolvedValue(resp);
 
  return Users.all().then(data => expect(data).toEqual(users));
});
```

### Mock Partials

Jest 也可以 mock 模块的一部分，例如

```js
// foo-bar-baz.js
export const foo = "foo";
export const bar = () => "bar";
export default () => "baz";
```

然后我们可以使用 `jest.mock(moduleName, factory)` 模拟 `foo-bar-baz`的部分实现，

关键点是使用 `jest.requireActual` 获取模块原来的定义，然后覆盖部分实现。

```js {3-12}
import defaultExport, {bar, foo} from './foo-bar-baz';

jest.mock('../foo-bar-baz', () => {
  const originalModule = jest.requireActual('../foo-bar-baz');

  return {
    __esModule: true, // Use it when dealing with esModules
    ...originalModule,
    default: jest.fn(() => 'mocked baz'),
    foo: 'mocked foo',
  };
});

test('should do a partial mock', () => {
  const defaultExportResult = defaultExport();
  expect(defaultExportResult).toBe('mocked baz');
  expect(defaultExport).toHaveBeenCalled();

  expect(foo).toBe('mocked foo');
  expect(bar()).toBe('bar');
});
```

还有很多关于 mock 函数的使用，详情请参考 [Mock Functions](https://jestjs.io/docs/mock-function-api).

### Mock Implementations

通过 `jest.mockImplementation` 和 `jest.mockImplementationOnce` 方法来替换函数的实现。

```js
const foo = jest
  .fn(() => "never call")
  .mockImplementationOnce(() => "first call")
  .mockImplementationOnce(() => "second call")
  .mockImplementation(() => "default");
test("mock implementation", () => {
  expect(foo()).toBe("first call");
  expect(foo()).toBe("second call");
  expect(foo()).toBe("default");
  expect(foo()).toBe("default");
});
```

#### Mock Return Values

如果 mock 函数只是返回一个值，可以使用 `jest.mockReturnValue` 和 `jest.mockReturnValueOnce` 代替

```js
const fn = jest.mockReturnValue(10)
// 等价于
// const fn = jest.fn(() => 10);
// const fn = jest.mockImplementation(() => 10);
```

#### Mock Return `this`

有时候为了方便级联调用，需要返回 `this`，可以使用 `jest.mockReturnThis` 

```js
const myObj = {
  myMethod: jest.fn().mockReturnThis(),
};

/*
等价于
const myObj = {
  myMethod: jest.fn(function () {
    return this;
  }),
};
*/
```

### Manual Mocks

#### Mocking user modules

手动模拟自定义模块，需要在模块同级目录下创建一个 `__mocks__` 目录，然后在这个目录下新建模块同名文件。比如要手动模拟 `modules/user.js`，需要创建 `modules/__mocks__/user.js`。

```js
// modules/__mocks__/user.js
const user = jest.createMockFromModule("../user.js");
user.upperName = jest.fn(() => "MOCK")
export default user;
```

然后在测试的时候，调用 `jest.mock('./moduleName')`，调用模块的 mock 实现。

```js
import user from "../src/modules/user"
jest.mock('../src/modules/user');

test("manual mock", () => {
  expect(user.upperName("anything")).toBe("MOCK");
});
```

#### Mocking Node modules

Jest 除了可以模拟自定义模块，还可以模拟第三方 node modules。在 `node_modules` 同级目录下创建 `__mocks__` 目录，然后在这个目录下新建模块同名文件，比如要手动模拟 `axios`，创建 `projectName/__mocks__/axios.js`。

在测试的时候，**不需要**像模拟自定义模块一样，调用 `jest.mock('axios')`

## References

- [Jest](https://jestjs.io/)
- [How To Mock Only One Function From A Module In Jest](https://www.chakshunyu.com/blog/how-to-mock-only-one-function-from-a-module-in-jest/)
- [`awesome-jest`](https://github.com/jest-community/awesome-jest)
- [`vscode-jest`](https://github.com/jest-community/vscode-jest)
- [`jest-extended`](https://github.com/jest-community/jest-extended)
- [`eslint-plugin-jest`](https://github.com/jest-community/eslint-plugin-jest)
- [`@sinonjs/fake-timers`](https://github.com/sinonjs/fake-timers)
- [`pretty-format`](https://yarnpkg.com/en/package/pretty-format) 
- [`snapshot-diff`](https://github.com/jest-community/snapshot-diff)

## Demo

[jest-demo](https://gitee.com/cp3hnu/web-demo/tree/master/jest-demo)
